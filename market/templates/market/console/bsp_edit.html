{# Copyright (C) 2017 Feedvay (Gagandeep Singh: singh.gagan144@gmail.com) - All Rights Reserved #}
{# Content in this document can not be copied and/or distributed without the express #}
{# permission of Gagandeep Singh. #}
{% extends 'console/base.html' %}
{% load static commontags %}

{% block head %}
    <!-- Favicon -->
    <link rel="shortcut icon"  href="{{ request.curr_org.icon.url }}" />

    <title>{{ bsp.name }} - Edit | {{ request.curr_org.name }}</title>

    <link href="{% get_static_prefix %}lib/select2/css/select2.css" rel="stylesheet">
    <link rel="stylesheet" href="{% get_static_prefix %}lib/select2/css/select2-bootstrap.css">
{% endblock %}

{% block page_header %}
    <div class="row wrapper border-bottom white-bg page-heading">
        <div class="col-xs-12">
            <h2>
                <img src="{% get_static_prefix %}images/bsp_types/{{ bsp.type }}-md.png" style="height: 30px;">&nbsp;
                {{ bsp.name }}
                <small style="color: #bbb;font-size: 13px;">({{ bsp.type|title }})</small>
            </h2>
            <ol class="breadcrumb">
                <li>
                    <a href="{% url 'console_org_home' %}?c={{ request.curr_org.org_uid }}">Home</a>
                </li>
                <li>
                    <a href="{% url 'console_market_bsp_panel' %}?c={{ request.curr_org.org_uid }}#/bsps">Business or Service Point</a>
                </li>
                <li class="active">
                    {{ bsp.name }}
                </li>
            </ol>
        </div>
    </div>
{% endblock %}

{% block content %}
    <div class="wrapper wrapper-content">
        <div class="container">
            <div style="margin-bottom: 20px;" ng-cloak>

                <form name="form_create_edit_bsp" class="form-horizontal" ng-controller="BspEditFormCtrl" novalidate>
                    {$ data $}

                    <!-- =============== Partial =============== -->

                    <!-- Basic -->
                    <div class="panel panel-default">
                        <div class="panel-body">

                            <div class="row">
                                <div class="col-md-6">
                                    <div>
                                        <label>Name of the Business or Service Point<span class="required">*</span>:</label>
                                        <input type="text" name="name" ng-model="data.name" class="form-control input-lg" placeholder="Enter here" required autocomplete="off"
                                               ng-class="{'error': (form_create_edit_bsp.name.$dirty && form_create_edit_bsp.name.$invalid) || flags.val_errors.name }"
                                        >
                                        <div ng-messages="form_create_edit_bsp.name.$dirty && form_create_edit_bsp.name.$error" role="alert" class="error_messages">
                                            <label ng-message="required" class="error">Please enter Business or Service Type name.</label>
                                        </div>
                                        <label ng-if="flags.val_errors.name" class="error">
                                            {$ flags.val_errors.name.join(", "); $}
                                        </label>
                                    </div>

                                    <div class="hr-line-dashed"></div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label>Type<span class="required">*</span>:</label>
                                            <select ng-model="data.type" name="type" class="form-control" select2="{ placeholder: 'Select type', allowClear: true }" required>
        {#                                            <option value="">Please Select</option>#}
                                                {% for t in BspTypes.choices %}
                                                    <option value="{{ t.0 }}">{{ t.1 }}</option>
                                                {% endfor %}
                                            </select>
                                            <div ng-messages="form_create_edit_bsp.type.$dirty && form_create_edit_bsp.type.$error" role="alert" class="error_messages">
                                                <label ng-message="required" class="error">Please select a Business or Service Point type.</label>
                                            </div>
                                            <label ng-if="flags.val_errors.type" class="error">
                                                {$ flags.val_errors.type.join(", "); $}
                                            </label>
                                        </div>

                                        <div class="col-md-6">
                                            <label>Brand:</label>
                                            <select ng-model="data.brand_id" name="brand_id" class="form-control">
                                                <option value="">Please Select</option>
                                                {% for b in list_brands %}
                                                    <option value="{{ b.id }}">{{ b.name }}</option>
                                                {% endfor %}
                                            </select>
                                            <div ng-messages="form_create_edit_bsp.brand_id.$dirty && form_create_edit_bsp.brand_id.$error" role="alert" class="error_messages">
                                                <label ng-message="required" class="error">Please select a brand.</label>
                                            </div>
                                            <label ng-if="flags.val_errors.brand_id" class="error">
                                                {$ flags.val_errors.brand_id.join(", "); $}
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label>Description:</label>
                                    <textarea summernote name="description" ng-model="data.description" config="summernote_config" required></textarea>
                                </div>
                            </div>


                        </div>
                    </div>
                    <!-- /Basic -->

                    <!-- Attributes -->
                    <div class="panel panel-default">
                        <div class="panel-heading panel_heading_2">
                            Attributes
                        </div>
                        <div class="panel-body">

                        </div>
                    </div>
                    <!-- /Attributes -->

                    <!-- Contact -->
                    <div class="panel panel-default">
                        <div class="panel-heading panel_heading_2">
                            <i class="fa fa-info"></i>&nbsp;
                            Contact Details
                        </div>
                        <div class="panel-body">
                            <div class="row">
                                <div class="col-md-5">
                                    <div style="margin-bottom: 25px;">
                                        <h4 style="margin-top: 0px;">
                                            <i class="fa fa-phone"></i>&nbsp;&nbsp;Phone Number
                                        </h4>
                                        <table class="table">
                                            <tbody>
                                                <tr ng-repeat="contact in data.contacts">
                                                    <td style="width: 90px;">
                                                        <input type="text" name="contact_tel_code_{$ $index $}" ng-model="contact.tel_code" class="form-control input-sm" required ng-class="{'error':form_create_edit_bsp['contact_tel_code_'+$index].$invalid}" placeholder="Code">
                                                    </td>
                                                    <td style="padding-right: 15px;">
                                                        <input type="text" name="contact_number_{$ $index $}" ng-model="contact.number" class="form-control input-sm" maxlength="10" required ng-class="{'error':form_create_edit_bsp['contact_number_'+$index].$invalid}" placeholder="Number">
                                                        <div ng-messages="form_create_edit_bsp['contact_number_'+$index].$error" role="alert" class="error_messages">
                                                            <label ng-message="required" class="error">Required</label>
                                                        </div>
                                                    </td>
                                                    <td style="width: 120px;">
                                                        <select ng-model="contact.type" name="contact_type_{$ $index $}" class="form-control input-sm" required ng-class="{'error':form_create_edit_bsp['contact_type_'+$index].$invalid}">
                                                            <option value="">-- Select --</option>
                                                            <option ng-repeat="ct in contact_types" value="{$ ct.id $}">{$ ct.name $}</option>
                                                        </select>
                                                        <div ng-messages="form_create_edit_bsp['contact_type_'+$index].$error" role="alert" class="error_messages">
                                                            <label ng-message="required" class="error">Required</label>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <button type="button" class="btn btn-danger btn-outline btn-xs" ng-click="remove_contact($index);">
                                                            <i class="fa fa-times"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                            <tfoot>
                                                <tr>
                                                    <td colspan="3">
                                                        <button type="button" class="btn btn-primary btn-xs" ng-click="add_contact();">
                                                            <i class="fa fa-plus"></i> Add new
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>

                                    <div style="margin-bottom: 25px;">
                                        <h4 style="margin-top: 0px;">
                                            <i class="fa fa-envelope-o"></i>&nbsp;&nbsp;Emails
                                        </h4>
                                        <hr style="margin: 10px 0px;"/>
                                        <input type="text" ng-model="data.emails" name="emails" class="form-control" select2="{ placeholder: 'Use comma or space to separate emails', tags: true, tokenSeparators: [',', ' '] }" tolist>
                                    </div>

                                    <div style="margin-bottom: 10px;">
                                        <h4 style="margin-top: 0px;">
                                            <i class="fa fa-globe"></i>&nbsp;&nbsp;Website/URL
                                        </h4>
                                        <hr style="margin: 10px 0px;"/>
                                        <input type="url" name="website" ng-model="data.website" class="form-control">
                                        <div ng-messages="form_create_edit_bsp.website.$error" role="alert" class="error_messages">
                                            <label ng-message="required" class="error">Required</label>
                                            <label ng-message="url" class="error">Please enter a valid URL.</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-7">
                                    <h4 style="margin-top: 0px;">
                                        <i class="fa fa-map-marker"></i>&nbsp;&nbsp;Address
                                    </h4>
                                    <hr style="margin: 10px 0px;"/>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- /Contact -->

                    <!-- =============== /Partial =============== -->
                </form>

            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script src="{% get_static_prefix %}lib/select2/js/select2.min.js"></script>
    <script>
        'use strict';

        var APP = angular.module('{{ app_name }}',[
            'feedvay.uiapp',
            'feedvay.common',
            'feedvay.watchdog',

            'ngCookies',
            'ngMessages',
            'ui.bootstrap',
            'angular-ladda'
        ])
        .run(function($http, $cookies) {
            $http.defaults.headers.post['X-CSRFToken'] = $cookies.csrftoken;

            $http.defaults.xsrfCookieName = 'csrftoken';
            $http.defaults.xsrfHeaderName = 'X-CSRFToken';
        })
        .config(function($interpolateProvider, $httpProvider) {
            $interpolateProvider.startSymbol('{$');
            $interpolateProvider.endSymbol('$}');

            $httpProvider.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest';
            $httpProvider.defaults.headers.post['Content-Type'] = 'application/x-www-form-urlencoded;charset=utf-8';
        });

        APP.controller('BspEditFormCtrl', function($scope, $http, $window){
{#            $scope.list_brands = [#}
{#                {% for b in list_brands %}#}
{#                    {"id": {{ b.id }}, "name": "{{ b.name }}", "logo_url":"{{ b.logo.url }}", "icon_url":"{{ b.icon.url }}"}{% if not forloop.last %},{% endif %}#}
{#                {% endfor %}#}
{#            ];#}
            // Variables
            $scope.summernote_config = {
                height: 150,
                toolbar: [
                    ['headline', ['style']],
                    ['style', ['bold', 'italic', 'underline']],
                    ['textsize', ['fontsize']],
                    ['fontclr', ['color']],
                    ['alignment', ['ul', 'ol', 'paragraph', 'lineheight']],
                    ['height', ['height']],
                    ['insert', ['link']],
                    ['help', ['help']]
                ]
            };

            $scope.contact_types = [
                {% for ct in ContactEmbDoc.CH_TYPE %}
                    {"id":"{{ ct.0 }}", "name": "{{ ct.1 }}"}{% if not forloop.last %},{% endif %}
                {% endfor %}
            ];

            $scope.data = {{ bsp.to_js_json|jsonify:False|safe }};

            // --- Utils function ---
            $scope.remove_contact = function(idx){
                $scope.data.contacts.splice(idx, 1);
            };

            $scope.add_contact = function(){
                $scope.data.contacts.push({"tel_code":"+91"});
            };
            // --- /Utils function ---

        });
    </script>
{% endblock %}