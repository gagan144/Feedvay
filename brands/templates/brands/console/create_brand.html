{# Copyright (C) 2017 Feedvay (Gagandeep Singh: singh.gagan144@gmail.com) - All Rights Reserved #}
{# Content in this document can not be copied and/or distributed without the express #}
{# permission of Gagandeep Singh. #}
{% extends 'console/base.html' %}
{% load static commontags %}

{% block head %}
    <title>Create new brand - Feedvay</title>
    <link href="{% get_static_prefix %}ui/css/plugins/colorpicker/colorpicker.css" rel="stylesheet">
{% endblock %}

{% block page_header %}
    <div class="row wrapper border-bottom white-bg page-heading">
        <div class="col-xs-12">
            <h2>
                <i class="fa fa-plus"></i>
                Create new brand
            </h2>
            <ol class="breadcrumb">
                <li>
                    <a href="{% url 'console_brands' %}">My brands</a>
                </li>
                <li class="active">
                    Create
                </li>
            </ol>
        </div>
    </div>
{% endblock %}

{% block content %}
    <div class="content_box" style="padding-top: 30px;margin-bottom: 20px;">
{#        <div ng-include="'{% get_static_prefix %}partials/brands/create_edit_brand.html'" ng-controller="NewBrandFormCtrl" ng-init="purpose='edit'"></div>#}
        <div static-include="{% get_static_prefix %}partials/brands/create_edit_brand.html" ng-controller="NewBrandFormCtrl" ng-init="purpose='create'"></div>


    </div>

{#    <div ng-controller = "NewBrandFormCtrl">#}
{#        <input type="file" file-model="myFile"/>#}
{#        <button ng-click="submit_brand()">upload me</button>#}
{#    </div>#}


{#    <div ng-controller = "myCtrl">#}
{#        <input type="file" file-model="myFile"/>#}
{#        <button ng-click="uploadFile()">upload me</button>#}
{#        {{ myFile }}#}
{#    </div>#}
{% endblock %}

{% block scripts %}
    <script src="{% get_static_prefix %}ui/js/plugins/colorpicker/bootstrap-colorpicker-module.js"></script>
    <script src="{% get_static_prefix %}lib/vibrantjs/Vibrant.js"></script>
    <script>
        'use strict';

        var APP = angular.module('{{ app_name }}',[
            'feedvay.watchdog',
            'feedvay.common',

            'ngCookies',
            'ngMessages',
            'ui.bootstrap',
            'colorpicker.module'
        ])
        .run(function($http, $cookies) {
            $http.defaults.headers.post['X-CSRFToken'] = $cookies.csrftoken;

            $http.defaults.xsrfCookieName = 'csrftoken';
            $http.defaults.xsrfHeaderName = 'X-CSRFToken';
        })
        .config(function($interpolateProvider, $httpProvider) {
            $interpolateProvider.startSymbol('{$');
            $interpolateProvider.endSymbol('$}');

            $httpProvider.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest';
            $httpProvider.defaults.headers.post['Content-Type'] = 'application/x-www-form-urlencoded;charset=utf-8';
        });


{#        APP.directive('fileModel', ['$parse', function ($parse) {#}
{#            return {#}
{#                restrict: 'A',#}
{#                link: function (scope, element, attrs) {#}
{#                    var model = $parse(attrs.fileModel);#}
{#                    var modelSetter = model.assign;#}
{##}
{#                    element.bind('change', function () {#}
{#                        scope.$apply(function () {#}
{#                            modelSetter(scope, element[0].files[0]);#}
{#                        });#}
{#                    });#}
{#                }#}
{#            };#}
{#        }]);#}

        APP.controller('NewBrandFormCtrl', function($scope, $http){
            $scope.pallets = []; //["#7a4426", "#7b9eae", "#348945", "#141414"];
            $scope.data = {
                ui_theme__primary: null
            }

            $scope.get_colors = function($event){
                var elem = event.target;

                $scope.pallets = [];

                if (elem.files && elem.files[0]) {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        var img_data = e.target.result;

                        var image = new Image(200, 200);
                        image.src = img_data;

                        var vibrant = new Vibrant(image);
                        var swatches = vibrant.swatches();

                        var pallets = []
                        for (var swatch in swatches) {
                            if (swatches.hasOwnProperty(swatch) && swatches[swatch]) {
                                var hex_color = swatches[swatch].getHex();
                                pallets.push(hex_color);
{#                                console.log(swatch, hex_color);#}
                            }
                        }

                        $scope.$apply(function () {
                            $scope.pallets = pallets;
                        });
                    }
                    reader.readAsDataURL(elem.files[0]);
                }
            }

            $scope.submit_brand = function(form_obj){
{#                if(form_obj.$invalid){#}
{#                    return false;#}
{#                }#}

                var file = $scope.myFile;

                // Prepare form data
                var fd = new FormData();
                fd.append('file', file);

                $http.post(
                    "{% url 'console_save_brand' %}",
                    fd,
                    {
                        transformRequest: angular.identity,
                        headers: {'Content-Type': undefined}
                    }
                )
                .success(function () {
                })
                .error(function () {
                });

            }

{#            $scope.submit_brand = function(form_obj){#}
{#                if(form_obj.$invalid){#}
{#                    return false;#}
{#                }#}
{##}
{#                var post_data = new FormData();#}
{#                for(var key in $scope.data){#}
{#                    post_data.append(key, $scope.data[key]);#}
{#                }#}
{#                post_data.append('file_logo', $scope.file_logo);#}
{##}
{#                // Post to server#}
{#                $http.post(#}
{#                    "{% url 'console_save_brand' %}",#}
{#                    post_data,#}
{#                    {#}
{#                        transformRequest: angular.identity,#}
{#                        headers: {'Content-Type': undefined}#}
{#                    }#}
{#                    //$.param($scope.data),#}
{#                )#}
{#                $http({#}
{#                    method: 'POST',#}
{#                    url: "{% url 'console_save_brand' %}",#}
{#                    headers: {#}
{#                        'Content-Type': $scope.data.file_logo.type#}
{#                    },#}
{#                    data: {#}
{#                        file_test: $scope.data.file_logo#}
{#                    }#}
{#                })#}
{#                .then(#}
{#                    function successCallback(response) {#}
{#                        $scope.flags.submitting = false;#}
{##}
{#                        if(response.data.status == 'success'){#}
{#                            $scope.flags.success = true;#}
{#                            $scope.data_chng_pass = {};#}
{#                        }else{#}
{#                            $scope.flags.submit_err_msg = response.data.message;#}
{#                        }#}
{#                    },#}
{#                    function errorCallback(response) {#}
{#                        $scope.flags.submitting = false;#}
{#                        if(response.status != -1){#}
{#                            $scope.flags.error = true;#}
{#                        }else{#}
{#                            $.growl.error({#}
{#                                title: '<i class="fa fa-signal"></i> Network error!',#}
{#                                message: "Please check your internet connection."#}
{#                            });#}
{#                        }#}
{#                    }#}
{#                );#}
{##}
{#            }#}


        });


{#        APP.service('fileUpload', ['$http', function ($http) {#}
{#            this.uploadFileToUrl = function(file, uploadUrl){#}
{#                var fd = new FormData();#}
{#                fd.append('file', file);#}
{#                $http.post(uploadUrl, fd, {#}
{#                    transformRequest: angular.identity,#}
{#                    headers: {'Content-Type': undefined}#}
{#                })#}
{#                .success(function(){#}
{#                })#}
{#                .error(function(){#}
{#                });#}
{#            }#}
{#        }]);#}

        APP.controller('myCtrl', function($scope, $http){

            $scope.uploadFile = function(){
                var file = $scope.myFile;
                console.log('file is ' );
                console.dir(file);
                var uploadUrl = "{% url 'console_save_brand' %}";

                var fd = new FormData();
                fd.append('file', file);
                $http.post(uploadUrl, fd, {
                    transformRequest: angular.identity,
                    headers: {'Content-Type': undefined}
                })
                .success(function(){
                })
                .error(function(){
                });


                //fileUpload.uploadFileToUrl(file, uploadUrl);
            };

        });
    </script>
{% endblock %}