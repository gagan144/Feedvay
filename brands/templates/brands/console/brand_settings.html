{# Copyright (C) 2017 Feedvay (Gagandeep Singh: singh.gagan144@gmail.com) - All Rights Reserved #}
{# Content in this document can not be copied and/or distributed without the express #}
{# permission of Gagandeep Singh. #}
{% extends 'console/base.html' %}
{% load static commontags %}

{% block head %}
    <!-- Favicon -->
    <link rel="shortcut icon"  href="{% if request.curr_brand %}{{ request.curr_brand.icon.url }}{% else %}{% get_static_prefix %}images/favicon.png{% endif %}" />

    <title page-title></title>


    <!-- Templates -->
    <script type="text/ng-template" id="tmpl_ownership">
        <div>
            <h2 style="margin-top: 0px;">
                <i class="fa fa-users"></i>&nbsp;
                Ownership
            </h2>
            <hr style="margin-top: 15px;"/>

            <!-- Self ownership -->
            <div>
                You are currently owner of the brand <span class="semi_bold">{$ brand_name $}</span>. Being owner
                gives you full rights & permissions over this brand and entities belonging to this brand. Be careful
                will modifying any settings of this brand.

                <div style="margin-top: 20px; padding-left: 50px;">
                    <h3>
                        <i class="fa fa-chain-broken"></i>&nbsp;
                        Disassociate yourself
                    </h3>
                    <div>
                        <p style="margin-bottom: 10px">
                            If you are no longer associated with this brand or wish to abandon your ownership for some reason,
                            you can click below button to disassociate yourself (Confirmation is asked).
                        </p>

                        <div  ng-hide="open_form">
                            <button class="btn btn-primary" type="button" ng-click="open_form=true;">
                                Release ownership
                            </button>
                        </div>

                        <div class="panel panel-default" ng-show="open_form">
                            <div class="panel-body panel_body_realign">
                                <form name="form_disassociate" ng-class="{'form-loading': flags.submitting }" novalidate >
                                    <div class="form-group">
                                        <div class="checkbox checkbox-primary" style="margin-top: 0px;">
                                            <input id="chk_confirm" type="checkbox" name="confirm" ng-model="data.confirm" required>
                                            <label for="chk_confirm">
                                                I agree that I willfully disassociate myself from the brand <span class="text-primary semi_bold">{{ request.curr_brand.name }}</span>.
                                                <br/>By this I release any kind of ownership or authority over this brand on Feedvay system.
                                                <br/>Also, I am also aware of the fact that my actions is irreversible once I commit.
                                            </label>
                                        </div>
                                    </div>

                                    <div class="hr-line-dashed"></div>
                                    <div class="form-group">
                                        <p class="text-danger" ng-if="flags.error">
                                            <i class="fa fa-exclamation-triangle"></i>&nbsp;
                                            {$ flags.error $}
                                        </p>

                                        <button ladda="flags.submitting" type="button" class="btn btn-danger ladda-button" ng-disabled="form_disassociate.$invalid" ng-click="submit_disassociation(form_disassociate);" data-style="zoom-in">
                                            Confirm disassociation
                                        </button>
                                        <button class="btn btn-default" type="button"  ng-click="data.confirm=null;open_form=false;">
                                            Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>


                    </div>
                </div>
            </div>
            <!-- /Self ownership -->

            {%  if list_other_owners %}
            <!-- Other owners -->
            <div style="margin-top: 40px;">
                <h3 style="margin-top: 0px;">
                    Other owners
                    <br><small>Other owner of this brand</small>
                </h3>
                <hr style="margin-top: 15px;"/>
                <div class="row">
                    {% for owner in list_other_owners %}
                        <div class="col-lg-6">
                            <div class="contact-box">
                                <div class="col-sm-4">
                                    <div class="text-center">
                                        <img alt="image" class="img-circle m-t-xs img-responsive" src="{% get_static_prefix %}images/avatar_default.png">
                                    </div>
                                </div>
                                <div class="col-sm-8">
                                    <h3>
                                        <strong>{{ owner.user.first_name }} {{ owner.user.last_name }}</strong>
                                    </h3>
                                    <p>
                                        <i class="fa fa-phone"></i>&nbsp;
                                        {{ owner.user.username }}
                                    </p>
                                    {% if owner.user.email %}
                                    <p>
                                        <i class="fa fa-email"></i>&nbsp;
                                        {{ owner.user.email }}
                                    </p>
                                    {% endif %}
                                </div>
                                <div class="clearfix"></div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            <!-- /Other owners -->
            {% endif %}

        </div>
    </script>

    <script type="text/ng-template" id="tmpl_details">
        <div>
            <h2 style="margin-top: 0px;">
                <i class="fa fa-info-circle"></i>&nbsp;
                Details
            </h2>
            <hr style="margin-top: 15px;"/>

            {% if request.curr_brand.status == 'verified' %}
                <div class="alert alert-success">
                    <h3>
                        <i class="fa fa-check-circle"></i>&nbsp;Verified!
                    </h3>
                    <p>
                        Your brand has been verified and is visible to public.
                    </p>
                </div>
            {% elif request.curr_brand.status == 'verification_pending' %}
                <div class="alert alert-warning">
                    <h3>
                        <i class="fa fa-clock-o"></i>&nbsp;Verification pending!
                    </h3>
                    <p>
                        Verification of your brand is still pending. Our team will shortly review your submission and
                        update you automatically. <br/>
                        Until then, your brand remains hidden from the public.
                    </p>
                </div>
            {% elif request.curr_brand.status == 'verification_failed' %}
                <div class="alert alert-warning">
                    <h3>
                        <i class="fa fa-ban"></i>&nbsp;Verification failed!
                    </h3>
                    <p>
                        Verification of your brand has been failed as per your submitted details. Kindly go through the
                        following instructions, correct your details accordingly and re-submit your brand.
                    </p>
                    <div style="margin: 5px 0px 0px 10px;padding-left: 20px;">
                        {{ request.curr_brand.failed_reason|safeseq }}
                    </div>
                    <p>Please note that your brand is hidden from the public until it is verified.</p>
                </div>
            {% endif %}

            <div static-include="{% get_static_prefix %}partials/brands/create_edit_brand.html"  ng-init="ACTION='edit'"></div>
        </div>
    </script>

    <script type="text/ng-template" id="tmpl_modal_review_submit">
        <div class="inmodal">
            <div class="modal-header" style="padding: 20px 15px;">
{#                <button type="button" class="close" ng-click="close()">#}
{#                    <span aria-hidden="true">&times;</span><span class="sr-only">Close</span>#}
{#                </button>#}
                <h4 class="modal-title">
                    <i class="fa fa-pencil-square-o"></i>&nbsp;
                    Review and submit brand changes
                </h4>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    Following is the summary of the changes that you have requested.
                    Please review them carefully before submitting.

                    <p style="margin: 5px 0px 0px 0px;" ng-if="data.brand_status!='verification_pending'">
                        After submitting, your change request will be queued for verification where one of our team member
                        will evaluate the changes for correctness and commit it accordingly. You will be automatically
                        updated accordignly.
                    </p>
                </div>

                <div style="padding: 0px 10px 0px 10px;">

                    <div ng-repeat="(field, new_value) in data.data_updates" ng-if="['file_logo', 'file_icon'].indexOf(field)==-1">
                        <div class="form-group" >
                            <label class="control-label">{$ field_text[field] $}:</label>
                            <div class="row">
                                <div class="col-xs-5 text-muted">
                                    {$ data.master_data[field] $}
                                </div>
                                <div class="col-xs-2" align="center" style="font-size: larger;">
                                    <i class="fa fa-arrow-right text-success"></i>
                                </div>
                                <div class="col-xs-5">
                                    {$ new_value $}
                                </div>
                            </div>
                        </div>
                        <div class="hr-line-dashed hr_line_dashed_m10"></div>
                    </div>

                    <div ng-if="data.file_logo">
                        <div class="form-group">
                            <label class="control-label">Logo:</label>
                            <div class="row">
                                <div class="col-xs-5">
                                    <img ng-src="{$ data.logo_url $}" class="img-thumbnail" style="max-width: 300px;">
                                </div>
                                <div class="col-xs-2" align="center" style="font-size: larger;">
                                    <i class="fa fa-arrow-right text-success"></i>
                                </div>
                                <div class="col-xs-5">
                                    <h3>{$ data.file_logo.name $}</h3>
                                </div>
                            </div>
                        </div>
                        <div class="hr-line-dashed hr_line_dashed_m10"></div>
                    </div>

                    <div ng-if="data.file_icon">
                        <div class="form-group">
                            <label class="control-label">Logo:</label>
                            <div class="row">
                                <div class="col-xs-5">
                                    <img ng-src="{$ data.icon_url $}" class="img-thumbnail" style="max-width: 300px;">
                                </div>
                                <div class="col-xs-2" align="center" style="font-size: larger;">
                                    <i class="fa fa-arrow-right text-success"></i>
                                </div>
                                <div class="col-xs-5">
                                    <h3>{$ data.file_icon.name $}</h3>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            <div class="modal-footer">
                <span ng-if="flags.error" class="text-danger pull-left">
                    Something went wrong. Our engineers will be informed.
                </span>

                <div ng-if="flags.submitting">
                    <img src="{% get_static_prefix %}images/loading/spinner_1.gif" style="height: 16px;">&nbsp;
                    Submitting changes ...
                </div>
                <div ng-show="!flags.submitting">
                    <button type="button" class="btn btn-white" ng-click="close()">Close</button>
                    <button type="button" class="btn btn-primary" ng-click="submit_changes()">
                        Submit {$ data.brand_status!='verification_pending'?'for verification':'' $}
                    </button>
                </div>
            </div>
        </div>


    </script>
    <!-- /Templates -->
{% endblock %}

{% block page_header %}
    <div class="row wrapper border-bottom white-bg page-heading">
        <div class="col-xs-12">
            <h2 class="m-b-none">
                {{ request.curr_brand.name }}<br/>
                <small>Settings</small>
            </h2>
        </div>
    </div>
{% endblock %}

{% block content %}
    <div ng-controller="MainCtrl" class="animated fadeInRight" ng-cloak>
        <div class="tabs-container">
            <div class="tabs-left">
                <ul class="nav nav-tabs">
                    <li ng-class="{'active': $state.current.name=='details'}">
                        <a ui-sref="details"><i class="fa fa-info-circle"></i> Details</a>
                    </li>
                    <li ng-class="{'active': $state.current.name=='ownership'}">
                        <a ui-sref="ownership"><i class="fa fa-users"></i> Ownership</a>
                    </li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane active">
                        <div class="panel-body">
                            <!-- Partial view div -->
                            <div ui-view></div>
                            <!-- Partial view div -->
                        </div>
                    </div>
                </div>

            </div>

        </div>

    </div>
{% endblock %}

{% block scripts %}
    <script src="{% get_static_prefix %}ui/js/ui-router/angular-ui-router.min.js"></script>

    <script src="{% get_static_prefix %}apps/brands/brands.js"></script>
    <script>
        'use strict';

        var APP = angular.module('{{ app_name }}',[
            'feedvay.common',
            'feedvay.watchdog',
            'feedvay.brands',

            'ngCookies',
            'ngMessages',
            'ui.router',                    // Routing
            'oc.lazyLoad',                  // ocLazyLoad
            'ui.bootstrap',
            'angular-ladda'
        ])
        .config(function($interpolateProvider, $httpProvider, $stateProvider, $urlRouterProvider, $ocLazyLoadProvider) {
            $interpolateProvider.startSymbol('{$');
            $interpolateProvider.endSymbol('$}');

            $httpProvider.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest';
            $httpProvider.defaults.headers.post['Content-Type'] = 'application/x-www-form-urlencoded;charset=utf-8';

            // ----- Routing -----
            $urlRouterProvider.otherwise("/details");   // Default state to load

            $ocLazyLoadProvider.config({
                // Set to true if you want to see what and when is dynamically loaded
                debug: false
            });

            $stateProvider
                .state('details', {
                    url: "/details",
                    templateUrl: "tmpl_details",
                    data: { pageTitle: 'Details - {{ request.curr_brand.name }}' },
                    controller: DetailsCtrl,
                    resolve: {
                        loadPlugin: function ($ocLazyLoad) {
                            return $ocLazyLoad.load([
                                {
                                    files:['{% get_static_prefix %}lib/vibrantjs/Vibrant.js']
                                },
                                {
                                    name: 'colorpicker.module',
                                    files: [
                                        '{% get_static_prefix %}ui/css/plugins/colorpicker/colorpicker.css',
                                        '{% get_static_prefix %}ui/js/plugins/colorpicker/bootstrap-colorpicker-module.js'
                                    ]
                                }
                            ]);
                        }
                    }
                })
                .state('ownership', {
                    url: "/ownership",
                    templateUrl: "tmpl_ownership",
                    data: { pageTitle: 'Ownership - {{ request.curr_brand.name }}' },
                    controller: OwnershipCtrl,
                })

        })
        .run(function($rootScope, $http, $cookies, $state) {
            $http.defaults.headers.post['X-CSRFToken'] = $cookies.csrftoken;

            $http.defaults.xsrfCookieName = 'csrftoken';
            $http.defaults.xsrfHeaderName = 'X-CSRFToken';

            // ----- Routing -----
            $rootScope.$state = $state;

            $rootScope.$on('$stateChangeError', function (event, toState, toParams, fromState, fromParams, error) {
                event.preventDefault();
                //console.log(error);

                if(error.status == -1){
                    $.growl.error({
                        title: '<i class="fa fa-signal"></i> Network error!',
                        message: "Please check your internet connection."
                    });
                }else{
                    $.growl.error({
                        title: '<i class="fa fa-exclamation-triangle"></i> Error!',
                        message: "Something went wrong. Our engineers will be informed."
                    });
                }

            });

        });


        APP.controller('MainCtrl', function($scope){

        });

        // ========== State Controllers ==========

        // ----- Details -----
        function DetailsCtrl($scope, $http, $window, ServiceBrandExistence, $uibModal){
            $scope.ServiceBrandExistence = ServiceBrandExistence;

            $scope.pallets = [];
            {% with brand=request.curr_brand %}
            $scope.logo_url = "{{ brand.logo.url }}";
            $scope.icon_url = "{{ brand.icon.url }}";
            var master_data = {
                id: {{ brand.id }},
                name: "{{ brand.name }}",
                acronym: {% if brand.acronym %}"{{ brand.acronym }}"{% else %}null{% endif %},
                description: "{{ brand.description }}",

                ui_theme__primary: {% if brand.ui_theme %}"{{ brand.ui_theme.primary }}"{% else %}null{% endif %},
            }
            $scope.data = angular.copy(master_data);
            {% endwith %}

            $scope.flags = {
                error: false,
                err_msg: null,
                val_errors: null
            }

            $scope.list_brands = [];
            $scope.find_brand = function(value){
                if(value) {
                    $scope.list_brands = ServiceBrandExistence.find(value).then(function (response) {
                        $scope.list_brands = response;
                    });
                }
            }

            $scope.get_colors = function($event){
                var elem = event.target;

                $scope.pallets = [];

                if (elem.files && elem.files[0]) {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        var img_data = e.target.result;

                        var image = new Image(200, 200);
                        image.src = img_data;

                        var vibrant = new Vibrant(image);
                        var swatches = vibrant.swatches();

                        var pallets = []
                        for (var swatch in swatches) {
                            if (swatches.hasOwnProperty(swatch) && swatches[swatch]) {
                                var hex_color = swatches[swatch].getHex();
                                pallets.push(hex_color);
                            }
                        }

                        $scope.$apply(function () {
                            $scope.pallets = pallets;
                        });
                    }
                    reader.readAsDataURL(elem.files[0]);
                }
            }

            $scope.submit_brand = function(form_obj) {
                if(form_obj.$invalid) {
                    return false;
                }

                $scope.flags.error= false;
                $scope.flags.err_msg = null;
                $scope.flags.val_errors= null;


                var data_updates = {};
                for(var key in $scope.data){
                    if($scope.data[key] != master_data[key]){
                        data_updates[key] = $scope.data[key];
                    }
                }

                if(!Object.keys(data_updates).length){
                    alert("Nothing has changed!");
                    return false;
                }

                // Open review modal
                var modalInstance = $uibModal.open({
                    animation: true,
                    templateUrl: 'tmpl_modal_review_submit',
                    controller: 'UpdateReviewSubmitCtrl',
                    size: 'lg',
                    backdrop: 'static',
                    windowClass: "animated bounceIn",
                    resolve: {
                        data: function(){
                            return {
                                master_data: master_data,
                                logo_url: $scope.logo_url,
                                icon_url: $scope.icon_url,
                                brand_status: "{{ request.curr_brand.status }}",

                                data_updates: angular.copy(data_updates),
                                file_logo: $scope.file_logo,
                                file_icon: $scope.file_icon
                            }
                        }

                    }
                });

                modalInstance.result.then(
                    function(result_err){
                        // Modal returned data; It must be an error.
                        console.log("Modal :", result_err);
                        $scope.flags.error = true;
                        $scope.flags.err_msg = result_err.err_msg;
                        $scope.flags.val_errors= result_err.val_errors;
                    },
                    function(){
                        // dismissed
                    }
                )

            }


        }

        APP.controller('UpdateReviewSubmitCtrl', function($scope, $uibModalInstance, $http, $window, data){
            $scope.data = data;

            $scope.field_text = {
                "name": "Name",
                "acronym": "Acronym",
                "description": "Description",
                "ui_theme__primary": "Primary color"
            };

            $scope.close = function () {
                $uibModalInstance.dismiss('cancel');
            };

            $scope.flags = {
                submitting: false,
                error: false,
                err_msg: null,
                val_errors: null
            };
            $scope.submit_changes = function(){
                $scope.flags.submitting = true;
                $scope.flags.error = false;
                $scope.flags.err_msg = null;
                $scope.flags.val_errors = null;

                var data_updates = $scope.data.data_updates;

                // Prepare form data
                var fd = new FormData();
                for(var key in data_updates){
                    if(!key.startsWith("file_") && data_updates[key]!=null) {
                        fd.append(key, data_updates[key]);
                    }
                }
                if($scope.data.file_logo) {
                    fd.append('file_logo', $scope.data.file_logo);
                }
                if($scope.data.file_icon) {
                    fd.append('file_icon', $scope.data.file_icon);
                }

                $http.post(
                    "/console/b/{{ request.curr_brand.brand_uid }}/brands/request-update/",
                    fd,
                    {
                        transformRequest: angular.identity,
                        headers: {'Content-Type': undefined}
                    }
                )
                .success(function (response, status, headers, config) {
                    $scope.flags.submitting = false;

                    if(response.status=='success'){
                        $window.location.reload();
                    }else{
                        var data_return = {
                            err_msg: response.message
                        };

                        if(response.status == 'failed'){
                            data_return["val_errors"] = response.errors;
                        }

                        $uibModalInstance.close(data_return);
                    }
                })
                .error(function (response, status, headers, config) {
                    $scope.flags.submitting = false;

                    if(status != -1){
                        $scope.flags.error = true;
                    }else{
                        $.growl.error({
                            title: '<i class="fa fa-signal"></i> Network error!',
                            message: "Please check your internet connection."
                        });
                    }
                });
            }
        });


        // --- Ownership ---
        function OwnershipCtrl($scope, $http, $window) {
            $scope.open_form = false;
            $scope.flags = {
                submitting: false,
                error: null
            }

            $scope.submit_disassociation = function(form_obj){
                if(form_obj.$invalid){
                    return false;
                }

                $scope.flags.submitting = true;
                $scope.flags.error = null;

                $http.post(
                    "/console/b/{{ request.curr_brand.brand_uid }}/brands/disassociate/",
                    $.param($scope.data)
                )
                .success(function (response, status, headers, config) {
                    $scope.flags.submitting = false;

                    if(response.status=='success'){
                        $window.location.href = '{% url 'console_brands' %}';
                    }else{
                        $scope.flags.error = response.message;
                    }
                })
                .error(function (response, status, headers, config) {
                    $scope.flags.submitting = false;

                    if(status != -1){
                        $scope.flags.error = "Something went wrong. Our engineers will be informed.";
                    }else{
                        $.growl.error({
                            title: '<i class="fa fa-signal"></i> Network error!',
                            message: "Please check your internet connection."
                        });
                    }
                });

            }
        }




        // ========== State Controllers ==========


    </script>
{% endblock %}