{# Copyright (C) 2017 Feedvay (Gagandeep Singh: singh.gagan144@gmail.com) - All Rights Reserved #}
{# Content in this document can not be copied and/or distributed without the express #}
{# permission of Gagandeep Singh. #}
{% extends 'console/base.html' %}
{% load static commontags %}

{% block head %}
    <!-- Favicon -->
    <link rel="shortcut icon"  href="{{ request.curr_org.icon.url }}" />

    <title page-title></title>

    <link href="{% get_static_prefix %}lib/select2/css/select2.css" rel="stylesheet">
    <link rel="stylesheet" href="{% get_static_prefix %}lib/select2/css/select2-bootstrap.css">

    <link rel="stylesheet" href="{% get_static_prefix %}ui/css/plugins/ui-select/select.min.css">

    <link href="{% get_static_prefix %}ui/css/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <link href="{% get_static_prefix %}ui/css/plugins/daterangepicker/daterangepicker-bs3.css" rel="stylesheet">
    <link href="{% get_static_prefix %}ui/css/plugins/datapicker/datepicker3.css" rel="stylesheet">

    <style>
        .marker_label {
            color: #ffffff;
            font-family: "Lucida Grande", "Arial", sans-serif;
            font-size: 14px;
            text-align: center;
            width: 30px;
            padding-top: 3px;
        }
    </style>

    <!-- ========== Templates ========== -->
    <!-- Dashboard -->
    <script type="text/ng-template" id="tmpl_dashboard">
        <div>
            <h2 style="margin-top: 0px;">
                <i class="fa fa-dashboard"></i>&nbsp;
                Dashboard
            </h2>
            <hr style="margin-top: 15px;"/>

            {% if list_graphs_dashboard|length %}
                <div class="row">
                    {% for graph in list_graphs_dashboard %}
                        <div class="col-md-6">
                            <graph-diagram type="{{ graph.graph_type }}" config="{ 'c':'{{ request.curr_org.org_uid }}', 'graph_uid':'{{ graph.graph_uid }}', 'title':'{{ graph.title|escapejs }}', 'description':'{{ graph.description|escapejs }}' }"></graph-diagram>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

        </div>
    </script>
    <!-- /Dashboard -->

    <!-- EditDetails -->
    <script type="text/ng-template" id="tmpl_edit_details">
        <div>
            <h2 style="margin-top: 0px;">
                <i class="fa fa-pencil"></i>&nbsp;
                Edit Details
            </h2>
            <hr style="margin-top: 15px;"/>

            <form name="form_create_edit_bsp" class="form-horizontal" novalidate>

                <div ng-include="'{% get_static_prefix %}partials/market/bsp/create_edit_bsp.html'" ng-init="ACTION='edit'"></div>

                <div class="panel panel-default">
                    <div class="panel-body">
                        <table style="width: 100%">
                            <tr>
                                <td style="width: 40%;">
                                    <label>Created By:</label>
                                    {% with creator=bsp.created_by_user %}
                                    <br/>{{ creator.first_name }} {{ creator.last_name }}
                                    {% endwith %}
                                </td>
                                <td style="width: 40%;">
                                    <label>Created On:</label>
                                    <br/>{{ bsp.created_on|date:"d-M-Y h:i A" }}
                                </td>
                                <td style="width: 20%;">
                                    <label>Last Modified On:</label>
                                    <br/>{% if bsp.modified_on %}{{ bsp.modified_on|date:"d-M-Y h:i A" }}{% else %}<i>Not modified yet</i>{% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>


                <hr class="hr-line-dashed"/>
                {% if request.permissions|has_permission:"market.businessservicepoint.change_businessservicepoint" %}
                    <div>
                        <p ng-if="flags.status==ST_AJAX.ERROR" class="text-danger">
                            <i class="fa fa-exclamation-triangle"></i> {$ flags.error_msg $}
                        </p>

                        <button ladda="flags.status==ST_AJAX.LOADING" class="btn btn-primary ladda-button" type="button" ng-disabled="form_create_edit_bsp.$invalid || templateError" ng-click="submit_bsp(form_create_edit_bsp);" data-style="zoom-in">
                            Save
                        </button>
                    </div>
                {% else %}
                    <div class="alert alert-warning">
                        <h3 style="margin-top: 0px;">
                            <i class="fa fa-exclamation-triangle"></i>
                            Cannot edit!
                        </h3>
                        <div>
                            You do not have permissions to change details for this Business or Service Point.
                        </div>
                    </div>
                {% endif %}

            </form>

        </div>
    </script>
    <!-- /EditDetails -->

    <!-- Feedback Questionnaire -->
    <script type="text/ng-template" id="tmpl_feedback_questionnaire">
        <div>
            <h2 style="margin-top: 0px;">
                <i class="ion-clipboard"></i>&nbsp;&nbsp;
                Feedback Questionnaire
            </h2>
            <hr style="margin: 15px 0px 10px 0px;"/>

            <div>
                <table class="table table-nobordered" style="font-size: 17px;">
                    <tbody>
                        <tr>
                            <td class="semi_bold" style="width: 150px;" valign="top">Questionnaire:</td>
                            <td valign="top">
                                {% if bsp.feedback_form.form_id %}
                                    <a href="{% url 'console_feedback_bsp_manage' bsp.feedback_form.form_id %}?c={{ request.curr_org.org_uid }}" target="_blank" style="color: inherit !important;"> {{ bsp.feedback_form.form.title }}</a>
                                {% else %}
                                    <div class="alert alert-info" style="font-size: 13px;margin-bottom: 10px;">
                                        No feedback questionnaire has been associated with <b>{{ bsp.name }}</b>.
                                        <br/> So, only <b>Rating</b> and <b>Review</b> are captured from customer as feedback.
                                    </div>
                                {% endif %}

                                {% if bsp.feedback_form.is_comment_ai_enabled %}
                                <div style="margin-top: 7px;">
                                    <i class="fa fa-android"></i>&nbsp;&nbsp;Artificial Intelligence is being applied on <span class="text-primary">reviews</span>
                                    made by the customer!
                                </div>
                                {% endif %}

                                {% if request.permissions|has_permission:"market.businessservicepoint.change_businessservicepoint" %}
                                    <div class="hr-line-dashed hr_line_dashed_m10"></div>
                                    <div style="font-size: 12px !important;margin-top: 10px;">
                                        <button ng-show="!select_questionnaire" class="btn btn-primary btn-xs" ng-click="select_questionnaire=true;">
                                            <i class="fa fa-pencil"></i>&nbsp;
                                            Change settings
                                        </button>
                                    </div>
                                {% endif %}
                            </td>
                        </tr>
                    </tbody>
                </table>


                <div ng-show="select_questionnaire" class="panel panel-default">
                    <div class="panel-heading">
                        Change feedback questionnaire
                        <a href="javascript: void(0);" class="close-link pull-right" style="color: inherit" ng-click="select_questionnaire=false">
                            <i class="fa fa-times"></i>
                        </a>
                    </div>
                    <div class="panel-body">
                        <form name="form_change_questnr" class="form-horizontal" novalidate>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">Questionnaire:</label>
                                <div class="col-sm-7">
                                    <select ng-model="data.form_id" name="form_id" class="form-control">
                                        <option value="">Select type</option>
                                        {% for form in list_feedback_forms %}
                                            <option value="{{ form.id }}">{{ form.title }}</option>
                                        {% endfor %}
                                    </select>
                                    <p class="help-block">
                                        Select feedback questionnaire that you want to associated with '{{ bsp.name }}'.
                                    </p>

                                    {% if bsp.feedback_form.form_id %}
                                    <p ng-if="data.form_id==null || data.form_id!={{ bsp.feedback_form.form_id }}">
                                        <i class="fa fa-reply"></i>&nbsp;
                                        Revert back feedback questionnaire to 
                                        <a href="javascript: void(0);" style="text-decoration: underline;" ng-click="data.form_id='{{ bsp.feedback_form.form_id }}'">{{ bsp.feedback_form.form.title }}</a>.
                                    </p>
                                    {% endif %}

                                    <div ng-messages="form_change_questnr.form_id.$dirty && form_change_questnr.form_id.$error" role="alert" class="error_messages">
                                        <label ng-message="required" class="error">Please select a feedback questionnaire.</label>
                                    </div>
                                </div>
                                <div class="col-sm-1" ng-show="data.form_id">
                                    <button class="btn btn-danger" ng-click="data.form_id=null">Remove</button>
                                </div>
                            </div>

                            <div class="hr-line-dashed hr_line_dashed_m10"></div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">Review:</label>
                                <div class="col-sm-8" style="padding-top: 7px;">
                                    <p>
                                        Select the following ArtificialIntelligence to be applied on review/comments made on
                                        <b>{{ bsp.name }}</b> by the customer.
                                        <i>It is not mandatory to associated feedback questionnaire to use this feature.</i>
                                    </p>

                                    <div class="form-group">
                                        <label class="col-sm-3 control-label">
                                            Sentiment:
                                        </label>
                                        <div class="col-sm-9">
                                            <div class="checkbox checkbox-primary">
                                                <input id="fld_ai_text_sentiment" type="checkbox" ng-model="data.ai_directives.text_sentiment">
                                                <label for="fld_ai_text_sentiment">
                                                    Quickly and efficiently determine if text is positive or negative.
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-3 control-label">
                                            Emotion:
                                        </label>
                                        <div class="col-sm-9">
                                            <div class="checkbox checkbox-primary">
                                                <input id="fld_ai_text_emotion" type="checkbox" ng-model="data.ai_directives.text_emotion">
                                                <label for="fld_ai_text_emotion">
                                                    Predicts the emotion expressed by the respondent in the answer.
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-3 control-label">
                                            Personality:
                                        </label>
                                        <div class="col-sm-9">
                                            <div class="checkbox checkbox-primary">
                                                <input id="fld_ai_text_personality" type="checkbox" ng-model="data.ai_directives.text_personality">
                                                <label for="fld_ai_text_personality">
                                                    Predicts the personality traits of the respondent based on his answers.
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-3 control-label">
                                            Personas:
                                        </label>
                                        <div class="col-sm-9">
                                            <div class="checkbox checkbox-primary">
                                                <input id="fld_ai_text_personas" type="checkbox" ng-model="data.ai_directives.text_personas">
                                                <label for="fld_ai_text_personas">
                                                    Predicts the Myers Briggs persona of the respondent
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="hr-line-dashed hr_line_dashed_m10"></div>
                            <div class="form-group">
                                <div class="col-sm-8 col-sm-offset-2">
                                    <p ng-if="flags.status==ST_AJAX.ERROR" class="text-danger">
                                        <i class="fa fa-exclamation-triangle"></i> {$ flags.error_msg $}
                                    </p>

                                    <button ladda="flags.status==ST_AJAX.LOADING" class="btn btn-primary ladda-button" type="button" ng-disabled="form_change_questnr.$invalid || templateError" ng-click="submit_change_questnr(form_change_questnr);" data-style="zoom-in">
                                        Save changes
                                    </button>
                                    <button class="btn btn-link" ng-click="select_questionnaire=false">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>


            {% if bsp.feedback_form.change_history|length %}
            <div style="margin-top: 40px;">
                <h3 class="semi_bold"><i class="fa fa-history"></i> Change History</h3>
                <hr style="margin: 10px 0px;"/>

                <table class="table table-stripped table-condensed">
                    <thead>
                        <tr>
                            <th style="width: 170px;">Date</th>
                            <th>Questionnaire</th>
                            <th style="width: 200px;">Associated By</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ch in bsp.feedback_form.change_history reversed %}
                            <tr>
                                <td>{{ ch.dated|date:"d-M-y h:i A" }}</td>
                                <td>
                                    <a href="{% url 'console_feedback_bsp_manage' ch.form_id %}?c={{ request.curr_org.org_uid }}" target="_blank">{{ ch.form.title }}</a>
                                </td>
                                <td>
                                    {% with user=ch.associated_by %}
                                        {{ user.first_name }} {{ user.last_name }}
                                    {% endwith %}
                                </td>

                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}

        </div>
    </script>
    <!-- /Feedback Questionnaire -->

    <!-- Rating & Reviews -->
    <script type="text/ng-template" id="tmpl_feedback_rating_reviews">
        <div>
            <h2 style="margin-top: 0px;">
                <i class="fa fa-star"></i>&nbsp;
                Rating & Reviews
            </h2>
            <hr style="margin-top: 15px;"/>

            <!-- Filters -->
            <div class="panel panel-default">
                <div class="panel-heading">
                    <i class="fa fa-filter"></i> Filters
                </div>
                <div class="panel-body">
                    <form name="form_filters" role="form" class="form-horizontal" novalidate>
                        <div class="row">
                            <div class="col-xs-5">
                                <div style="margin-bottom: 6px;">
                                    <span style="font-weight: 700;">Date range:</span>

                                    <div class="btn-group btn-group-xs pull-right">
                                        <button class="btn btn-default" type="button" ng-click="set_filter_daterange('today')">Today</button>
                                        <button class="btn btn-default" type="button" ng-click="set_filter_daterange('last7days')">Last 7 days</button>
                                        <button class="btn btn-default" type="button" ng-click="set_filter_daterange('last30days')">Last 30 days</button>
                                    </div>
                                </div>
                                <input date-range-picker name="response_date"
                                       class="form-control input-sm date-picker fake_readonly" type="text"
                                       ng-model="filters.response_date"
                                       options="{separator: '  to  ', format: 'DD-MMM-YYYY'}"
                                       placeholder="Select a date range to filter responses"
                                       readonly
                                       required
                                />
                            </div>
                        </div>

                        <div class="hr-line-dashed hr_line_dashed_m10"></div>
                        <div>
                            <button type="button" class="btn btn-primary btn-sm ladda-button" ng-click="view_rating_review(form_filters)" ladda="ui_flags.loading" data-style="zoom-in" ng-disabled="form_filters.$invalid">
                                <i class="fa fa-search"></i>&nbsp;&nbsp;View
                            </button>
                        </div>

                    </form>
                </div>
            </div>
            <!-- /Filters -->

            <div ng-show="ui_flags.loaded">
                <!-- Response grid -->
                <ng-jqgrid
                        config="grid_rating_reviews.config"
                        modeldata="list_rating_reviews"
                        gridid="{$ grid_rating_reviews.gridid $}"
                        pagerid="{$ grid_rating_reviews.pagerid $}"
                        api="grid_rating_reviews.gridapi"
                        filtertoolbar="{stringResult: true, searchOnEnter: false, defaultSearch: 'cn'}"
                ></ng-jqgrid>
                <!-- /Response grid -->
            </div>

        </div>
    </script>
    <!-- /Rating & Reviews -->


    <!-- Feedback Responses -->
    <script type="text/ng-template" id="tmpl_feedback_responses">
        <div>
            <h2 style="margin-top: 0px;">
                <i class="fa fa-commenting"></i>&nbsp;
                Feedback Responses
            </h2>
            <hr style="margin-top: 15px;"/>

            <!-- Filters -->
            <div class="panel panel-default">
                <div class="panel-heading">
                    <i class="fa fa-filter"></i> Filters
                </div>
                <div class="panel-body">
                    <form role="form" class="form-horizontal" novalidate>
                        <div class="row">
                            <div class="col-xs-5">
                                <div style="margin-bottom: 6px;">
                                    <span style="font-weight: 700;">Date range:</span>

                                    <div class="btn-group btn-group-xs pull-right">
                                        <button class="btn btn-default" type="button" ng-click="set_filter_daterange('today')">Today</button>
                                        <button class="btn btn-default" type="button" ng-click="set_filter_daterange('last7days')">Last 7 days</button>
                                        <button class="btn btn-default" type="button" ng-click="set_filter_daterange('last30days')">Last 30 days</button>
                                    </div>
                                </div>
                                <input date-range-picker name="response_date"
                                       class="form-control input-sm date-picker fake_readonly" type="text"
                                       ng-model="filters_response.response_date"
                                       options="{separator: '  to  ', format: 'DD-MMM-YYYY'}"
                                       placeholder="Select a date range to filter responses"
                                       readonly
                                />
                            </div>
                            <div class="col-xs-5">
                                <label>Suspect?</label>
                                <div>
                                    <div class="radio radio-danger radio-inline">
                                        <input type="radio" id="rd_suspect_true" value="1" name="flags__suspect" ng-model="filters_response.flags__suspect" required>
                                        <label for="rd_suspect_true">Yes</label>
                                    </div>
                                    <div class="radio radio-success radio-inline">
                                        <input type="radio" id="rd_suspect_false" value="0" name="flags__suspect" ng-model="filters_response.flags__suspect" required>
                                        <label for="rd_suspect_false">No</label>
                                    </div>

                                    <div class="radio radio-inline" style="padding-left: 5px;">
                                        |
                                        <button class="btn btn-link btn-xs" ng-click="filters_response.flags__suspect=undefined;">
                                            <i class="fa fa-times"></i> Clear
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="hr-line-dashed hr_line_dashed_m10"></div>
                        <div>
                            <button type="button" class="btn btn-primary btn-sm ladda-button" ng-click="view_response_report()" ladda="ui_flags.loading" data-style="zoom-in">
                                <i class="fa fa-search"></i>&nbsp;&nbsp;View
                            </button>
                        </div>

                    </form>
                </div>
            </div>
            <!-- /Filters -->

            <div ng-show="ui_flags.loaded">
                <!-- Response grid -->
                <ng-jqgrid
                        config="grid_responses.config"
                        modeldata="list_responses"
                        gridid="{$ grid_responses.gridid $}"
                        pagerid="{$ grid_responses.pagerid $}"
                        api="grid_responses.gridapi"
                        filtertoolbar="{stringResult: true, searchOnEnter: false, defaultSearch: 'cn'}"
                ></ng-jqgrid>
                <!-- /Response grid -->
            </div>

            <!-- Map -->
            <section id="div_map_responses" style="margin-top: 30px;display:none;">
                <div ui-map="MAP_RESPONSES" ui-options="mapOptions" class="google-map" style="height: 550px;" ></div>
            </section>
            <!-- /Map -->

        </div>
    </script>
    <!-- /Feedback Responses -->

    <!-- ========== /Templates ========== -->

    <!-- Jquery templates -->
    <script id="jqtmpl_map_response_dialogue" type="text/x-jquery-tmpl">
        <div>
            <table style="width: 220px;margin-top:7px;">
                <tr>
                    <td style="width: 55px;" valign="top">
                        <i class="fa fa fa-comments-o text-primary" style="font-size: 50px;"></i>
                    </td>
                    <td valign="top" style="padding-left:10px;">
                        <h3 style="margin-top: 0px;">
                            ${user.user_fullname}<br/>
                            <small>${user.username}</small>
                        </h3>

                        <div style="font-size: 11px;">
                            <div style="margin-bottom:15px;">
                                On ${moment(response_date).format("DD-MMM-YYYY hh:mm A")}
                            </div>

                            {% templatetag openvariable %}if flags.suspect{% templatetag closevariable %}
                                <div class="text-danger" style="margin-bottom:15px;">
                                    <i class="fa fa-question text-danger"></i> <span >Suspect</span>
                                </div>
                            {% templatetag openvariable %}/if{% templatetag closevariable %}

                            <a href="/console/surveys/{{ survey.survey_uid }}/response/${response_uid}/" target="_blank" class="btn btn-primary btn-xs">View</a>
                        </div>

                    </td>
                </tr>
            </table>
        </div>
    </script>

    <script id="jqtmpl_grip_response_caption" type="text/x-jquery-tmpl">
        <div>
            <b class="text-primary">${length}</b>&nbsp;&nbsp;Responses
            {% templatetag openvariable %}if filtered{% templatetag closevariable %}
                <small style="font-size: 10px;">(Filtered)</small>
            {% templatetag openvariable %}/if{% templatetag closevariable %}
        </div>
    </script>
    <!-- /Jquery templates -->
{% endblock %}

{% block page_header %}
    <div class="row wrapper border-bottom white-bg page-heading">
        <div class="col-xs-12">
            <h2>
                <img src="{% get_static_prefix %}images/bsp_types/{{ bsp.type }}-md.png" style="height: 30px;">&nbsp;
                {{ bsp.name }}
                <small style="color: #bbb;font-size: 13px;">({{ bsp.type|title }})</small>
            </h2>
            <ol class="breadcrumb">
                <li>
                    <a href="{% url 'console_org_home' %}?c={{ request.curr_org.org_uid }}">Home</a>
                </li>
                <li>
                    <a href="{% url 'console_market_bsp_panel' %}?c={{ request.curr_org.org_uid }}#/bsps">Business or Service Point</a>
                </li>
                <li class="active">
                    {{ bsp.name }}
                </li>
            </ol>
        </div>
    </div>
{% endblock %}

{% block content %}
    <div class="wrapper_admin_content" ng-controller="MainCtrl" ng-cloak>
        <table class="table_tab_admin">
            <tr>
                <td class="admin_tabs" valign="top">
                    <div class="list-group list_group_tabs" >
                        <a ui-sref="dashboard" class="list-group-item" ng-class="{'active': $state.current.name=='dashboard'}">
                            <i class="fa fa-dashboard list_md_icon"></i> Dashboard
                        </a>
                        <a ui-sref="edit" class="list-group-item" ng-class="{'active': $state.current.name=='edit'}">
                            <i class="fa fa-pencil list_md_icon"></i> Edit Details
                        </a>
                        <a ui-sref="feedback_questionnaire" class="list-group-item" ng-class="{'active': $state.current.name=='feedback_questionnaire'}">
                            <i class="ion-clipboard list_md_icon"></i> Feedback Questionnaire
                        </a>

                        <div class="list-group-item">
                            <i class="ion-chatbubbles list_md_icon"></i> Feedback
                        </div>
                        <a ui-sref="feedback_rating_reviews" class="list-group-item list_group_subitem" ng-class="{'active': $state.current.name=='feedback_rating_reviews'}">
                            <i class="fa fa-star list_md_icon"></i> Rating & Reviews
                        </a>
                        <a ui-sref="feedback_responses" class="list-group-item list_group_subitem" ng-class="{'active': $state.current.name=='feedback_responses'}">
                            <i class="fa fa-commenting list_md_icon"></i> Responses
                        </a>
                    </div>
                </td>
                <td class="admin_content" valign="top">
                    <!-- Partial view div -->
                    <div ui-view></div>
                    <!-- Partial view div -->
                </td>
            </tr>
        </table>
    </div>
{% endblock %}

{% block scripts %}
    <script src="{% get_static_prefix %}ui/js/ui-router/angular-ui-router.min.js"></script>
    <script src="{% get_static_prefix %}lib/select2/js/select2.min.js"></script>
    <script src="{% get_static_prefix %}lib/angular/checklist-model.js"></script>
    <script src="{% get_static_prefix %}ui/js/plugins/datapicker/bootstrap-datepicker.js"></script>
    <script src="{% get_static_prefix %}ui/js/plugins/daterangepicker/daterangepicker.js"></script>
    <script src="{% get_static_prefix %}ui/js/plugins/daterangepicker/angular-daterangepicker.js"></script>
    <script type="text/javascript" src="{% get_static_prefix %}lib/jquery-tmpl/jquery.tmpl.min.js"></script>

    <script src="{% get_static_prefix %}ui/js/plugins/ui-select/select.min.js"></script>

    <script src="{% get_static_prefix %}ui/js/plugins/jqGrid/i18n/grid.locale-en.js"></script>
    <script src="{% get_static_prefix %}ui/js/plugins/jqGrid/jquery.jqGrid.min.js"></script>
    <script src="{% get_static_prefix %}lib/angular/angular-jqgrid/angular-jqgrid.js"></script>

    <script src="https://maps.google.com/maps/api/js?libraries=placeses,visualization,drawing,geometry,places"></script>
    <script src="{% get_static_prefix %}lib/maps/ng-map/ng-map.min.js"></script>
{#    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js"></script>#}
    <script type="text/javascript" src="{% get_static_prefix %}lib/maps/markerwithlabel_1_1_10.js"></script>

    <!-- Graphs -->
    <script type="text/javascript" src="{% get_static_prefix %}ui/js/plugins/flot/jquery.flot.js"></script>
    <script type="text/javascript" src="{% get_static_prefix %}ui/js/plugins/flot/jquery.flot.time.js"></script>
    <script type="text/javascript" src="{% get_static_prefix %}ui/js/plugins/flot/jquery.flot.tooltip.min.js"></script>
    <script type="text/javascript" src="{% get_static_prefix %}ui/js/plugins/flot/jquery.flot.spline.js"></script>
    <script type="text/javascript" src="{% get_static_prefix %}ui/js/plugins/flot/jquery.flot.resize.js"></script>
    <script type="text/javascript" src="{% get_static_prefix %}ui/js/plugins/flot/jquery.flot.pie.js"></script>
    <script type="text/javascript" src="{% get_static_prefix %}ui/js/plugins/flot/curvedLines.js"></script>
    <script type="text/javascript" src="{% get_static_prefix %}ui/js/plugins/flot/angular-flot.js"></script>
    <!-- /Graphs -->

    <script src="{% get_static_prefix %}apps/geography/geography.js"></script>
    <script src="{% get_static_prefix %}apps/feedback/bsp_feedback.js"></script>
    <script src="{% get_static_prefix %}apps/reports/graph.js"></script>

    <script>
        'use strict';

        var APP = angular.module('{{ app_name }}',[
            'feedvay.uiapp',
            'feedvay.common',
            'feedvay.watchdog',
            'feedvay.geography',
            'feedvay.feedback.bsp',
            'feedvay.reports.graphs',

            'ngCookies',
            'ngMessages',
            'ui.bootstrap',
            'ui.router',                    // Routing
            'oc.lazyLoad',                  // ocLazyLoad
            'angular-ladda',
            'checklist-model',
            'ui.select',
            'ngSanitize',
            'ngMap',
            'daterangepicker',
            'angular-jqgrid',
        ])
        .config(function($interpolateProvider, $httpProvider, $stateProvider, $urlRouterProvider, $ocLazyLoadProvider) {
            $interpolateProvider.startSymbol('{$');
            $interpolateProvider.endSymbol('$}');

            $httpProvider.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest';
            $httpProvider.defaults.headers.post['Content-Type'] = 'application/x-www-form-urlencoded;charset=utf-8';

            // ----- Routing -----
            $urlRouterProvider.otherwise("/dashboard");   // Default state to load

            $ocLazyLoadProvider.config({
                // Set to true if you want to see what and when is dynamically loaded
                debug: false
            });

            $stateProvider
                .state('dashboard', {
                    url: "/dashboard",
                    templateUrl: "tmpl_dashboard",
                    data: { pageTitle: 'Dashboard - {{ bsp.name }} | {{ request.curr_org.name }}' },
                    controller: DashboardCtrl,
                })
                .state('edit', {
                    url: "/edit",
                    templateUrl: "tmpl_edit_details",
                    data: { pageTitle: 'Edit - {{ bsp.name }} | {{ request.curr_org.name }}' },
                    controller: EditDetailsCtrl,
                })
                .state('feedback_questionnaire', {
                    url: "/feedback_questionnaire",
                    templateUrl: "tmpl_feedback_questionnaire",
                    data: { pageTitle: 'Feedback Questionnaire - {{ bsp.name }} | {{ request.curr_org.name }}' },
                    controller: FeedbackQuestionnaireCtrl,
                })
                .state('feedback_rating_reviews', {
                    url: "/feedback_rating_reviews",
                    templateUrl: "tmpl_feedback_rating_reviews",
                    data: { pageTitle: 'Rating & Reviews - {{ bsp.name }} | {{ request.curr_org.name }}' },
                    controller: RatingReviewsCtrl,
                })
                .state('feedback_responses', {
                    url: "/feedback_responses",
                    templateUrl: "tmpl_feedback_responses",
                    data: { pageTitle: 'Feedback Responses - {{ bsp.name }} | {{ request.curr_org.name }}' },
                    controller: FeedbackResponsesCtrl,
                    resolve: {
                        loadPlugin: function ($ocLazyLoad) {
                            return $ocLazyLoad.load([
                                {
                                    name: 'ui.event',
                                    files: ['{% get_static_prefix %}ui/js/plugins/uievents/event.js']
                                },
                                {
                                    name: 'ui.map',
                                    files: ['{% get_static_prefix %}ui/js/plugins/uimaps/ui-map.js']
                                },
                            ]);
                        }
                    }
                });



            // ----- /Routing -----
        })
        .run(function($rootScope, $http, $cookies, $state) {
            $http.defaults.headers.post['X-CSRFToken'] = $cookies.csrftoken;

            $http.defaults.xsrfCookieName = 'csrftoken';
            $http.defaults.xsrfHeaderName = 'X-CSRFToken';

{#            $rootScope.ST_AJAX = ST_AJAX;#}

            // ----- Routing -----
            $rootScope.$state = $state;

            $rootScope.$on('$stateChangeError', function (event, toState, toParams, fromState, fromParams, error) {
                event.preventDefault();
                //console.log(error);

                if(error.status == -1){
                    $.growl.error({
                        title: '<i class="fa fa-signal"></i> Network error!',
                        message: "Please check your internet connection."
                    });
                }else{
                    $.growl.error({
                        title: '<i class="fa fa-exclamation-triangle"></i> Error!',
                        message: "Something went wrong. Our engineers will be informed."
                    });
                }

            });
            // ----- /Routing -----

        });


        APP.controller('MainCtrl', function($scope){

        });

        // ========== State Controllers ==========

        // --- DashboardCtrl ---
        function DashboardCtrl($scope){

        }
        // --- /DashboardCtrl ---

        // --- Edit Details ---
        function EditDetailsCtrl($scope, $http, $window, ServiceGeoLocation){

            $scope.$on('templateError', function(e, data) {
                $scope.templateError = true;
{#                $scope.templateErrorUrl = data.url;#}
            });

            // Variables
            $scope.summernote_config = {
                height: 150,
                toolbar: [
                    ['headline', ['style']],
                    ['style', ['bold', 'italic', 'underline']],
                    ['textsize', ['fontsize']],
                    ['fontclr', ['color']],
                    ['alignment', ['ul', 'ol', 'paragraph', 'lineheight']],
                    ['height', ['height']],
                    ['insert', ['link']],
                    ['help', ['help']]
                ]
            };

            $scope.list_bsp_type = [
                {% for t in BspTypes.choices %}
                    {"id":"{{ t.0 }}", "name": "{{ t.1 }}"}{% if not forloop.last %},{% endif %}
                {% endfor %}
            ];

            $scope.list_brands = [
                {% for b in list_brands %}
                    {"id": {{ b.id }}, "name": "{{ b.name }}"}{% if not forloop.last %},{% endif %}
                {% endfor %}
            ];

            $scope.contact_types = [
                {% for ct in ContactEmbDoc.CH_TYPE %}
                    {"id":"{{ ct.0 }}", "name": "{{ ct.1 }}"}{% if not forloop.last %},{% endif %}
                {% endfor %}
            ];

            $scope.ORG_UID = '{{ request.curr_org.org_uid }}';

            $scope.data = {{ bsp.to_js_json|jsonify:False|safe }};

            // --- Utils function ---
            $scope.remove_contact = function(idx){
                $scope.data.contacts.splice(idx, 1);
            };

            $scope.add_contact = function(){
                $scope.data.contacts.push({"tel_code":"+91"});
            };

            // Geolocation
            $scope.searchRes_geolocation = [];
            $scope.search_geolocation = function ($select) {
                if($select.search.length>=3) {
                    return ServiceGeoLocation.search_geolocation($select.search, 'locality').then(
                        function (response) {
                            $scope.searchRes_geolocation = response.objects;
                        }
                    );
                }
            };

            $scope.clear_address = function(){
                delete $scope.data.address;
            };

            $scope.onclick_map = function(event){
                var coord = event.latLng;
                $scope.data.address.coordinates = [coord.lng(), coord.lat()];
            };
            $scope.ondragged_curr_location = function(){
                var coord = this.getPosition();
                $scope.data.address.coordinates = [coord.lng(), coord.lat()];
            };
            // --- /Utils function ---

            $scope.flags = {
                status: null,
                error_msg: null,
                errors: null
            };
            $scope.submit_bsp = function(form_obj) {
                if (form_obj.$invalid) {
                    return false;
                }

                // Prepare data
                var bsp_data = angular.copy($scope.data);
                if(bsp_data['address'] && bsp_data['address']['geolocation']){
                    var split_addr = bsp_data['address']['geolocation']['full_address'].split(", ");

                    bsp_data['address']['location_code'] = bsp_data['address']['geolocation']['code'];
                    bsp_data['address']['locality'] = split_addr[0];
                    bsp_data['address']['city'] = split_addr[1];
                    bsp_data['address']['state'] = split_addr[2];
                    bsp_data['address']['country'] = split_addr[3];
                    bsp_data['address']['pincode'] = bsp_data['address']['geolocation']['pincode'];

                    delete bsp_data['address']['geolocation'];
                }

                var data = {
                    "data": angular.toJson( bsp_data ), //JSON.stringify($scope.data),
                    "c": "{{ request.curr_org.org_uid }}"
                };

                $scope.flags.status = ST_AJAX.LOADING;
                $scope.flags.error_msg = null;
                $scope.flags.errors = null;

                $http.post(
                    "{% url 'console_market_bsp_edit_save' bsp.id %}",
                    $.param(data)
                )
                .success(function (response, status, headers, config) {
                    if(response.status=='success'){
{#                        $window.location.href = '{% url 'console_market_bsp_manage' bsp.pk %}?c={{ request.curr_org.org_uid }}#/edit';#}
                        $window.location.reload();
                    }else{
                        $scope.flags.status = ST_AJAX.ERROR;
                        $scope.flags.error_msg = response.message;
                        if(response.status == 'failed'){
                            $scope.flags.errors = response.errors;
                        }
                    }
                })
                .error(function (response, status, headers, config) {
                    if(status != -1){
                        $scope.flags.status = ST_AJAX.ERROR;
                        $scope.flags.error_msg = "Something went wrong. Our engineers will be informed.";
                    }else{
                        $scope.flags.status = null;
                        $.growl.error({
                            title: '<i class="fa fa-signal"></i> Network error!',
                            message: "Please check your internet connection."
                        });
                    }
                });


            };

        }
        // --- /Edit Details ---

        // --- FeedbackQuestionnaireCtrl ---
        function FeedbackQuestionnaireCtrl($scope, $http, $window){
            $scope.flags = {
                status: null,
                error_msg: null
            };

            $scope.data = {
                form_id: {% if bsp.feedback_form.form_id %}"{{ bsp.feedback_form.form_id }}"{% else %}null{% endif %},
                {% if bsp.feedback_form.ai_comment_directives %}
                ai_directives: {{ bsp.feedback_form.ai_comment_directives|jsonify|safe }}
                {% endif %}
            };

            $scope.submit_change_questnr = function(form_obj){
                if (form_obj.$invalid) {
                    return false;
                }

                $scope.flags.status = ST_AJAX.LOADING;
                $scope.flags.error_msg = null;

                $http.post(
                    "{% url 'console_feedback_bsp_associate_form' bsp.id %}?c={{ request.curr_org.org_uid }}",
                    $.param({
                        "data": JSON.stringify($scope.data)
                    })
                )
                .success(function (response, status, headers, config) {
                    if(response.status=='success'){
                        $window.location.reload();
                    }else{
                        $scope.flags.status = ST_AJAX.ERROR;
                        $scope.flags.error_msg = response.message;
                    }
                })
                .error(function (response, status, headers, config) {
                    if(status != -1){
                        $scope.flags.status = ST_AJAX.ERROR;
                        $scope.flags.error_msg = "Something went wrong. Our engineers will be informed.";
                    }else{
                        $scope.flags.status = null;
                        $.growl.error({
                            title: '<i class="fa fa-signal"></i> Network error!',
                            message: "Please check your internet connection."
                        });
                    }
                });

            }
        }
        // --- /FeedbackQuestionnaireCtrl ---

        // --- Rating & Reviews ---
        function RatingReviewsCtrl($scope, ServiceBspFeedback){
            // filters
            $scope.filters = {
                "response_date":{
                    "startDate": moment().add(-1, 'months'),
                    "endDate": moment()
                }
            };
            $scope.set_filter_daterange = function(key){
                switch (key){
                    case 'today': {
                            $scope.filters["response_date"] = {
                                "startDate": moment(),
                                "endDate": moment()
                            };
                        }break;
                    case 'last7days': {
                            $scope.filters["response_date"] = {
                                "startDate": moment().add(-7, 'days'),
                                "endDate": moment()
                            };
                        }break;
                    case 'last30days': {
                            $scope.filters["response_date"] = {
                                "startDate": moment().add(-30, 'days'),
                                "endDate": moment()
                            };
                        }break;
                    default: { alert("Invalid date range option!"); }

                }
            };

            // UI
            $scope.ui_flags = {
                loading: false,
                loaded: false
            };

            // Jqgrid
            $scope.grid_rating_reviews = {
                gridid: "grid_rating_reviews",
                pagerid: "grid_rating_reviews_pager",
                config: {
                    datatype: "local",
                    colNames: [
                        'Dated',
                        'Respondent',
                        'Rating',
                        'Comment',
                        'Sentiment'
                    ],
                    colModel: [
                        { name: 'dated', index: 'dated', width: 60,
                            sorttype:'date', formatter: "date", formatoptions: { srcformat: 'Y-m-dTH:i:s', newformat: 'd-M-Y h:i A' },
                            searchoptions: {
                                attr:{ placeholder: 'Select date', readonly:'readonly'},
                                dataInit: function (elem) {
                                    $(elem).datepicker({
                                        format: 'yyyy-mm-dd',
                                        keyboardNavigation: false,
                                        autoclose: true,
                                        todayHighlight: true,
                                    }).on('changeDate', function(e) {
                                        $('#grid_rating_reviews')[0].triggerToolbar();
                                    });
                                }
                            }
                        },
                        { name: 'respondent', index: 'respondent', width: 100 },
                        { name: 'rating', index: 'rating', width: 40, sorttype:'int', align:"center",
                            stype: 'select', searchoptions:{ sopt:['eq'], value: ":All;1:1;2:2;3:3;4:4;5:5", clearSearch: false}
                        },
                        { name: 'comment.text', index: 'comment.text', width: 200 },
                        { name: 'comment.ai.text_sentiment.result.sentiment', index: 'comment.ai.text_sentiment.result.sentiment', width: 60, align:"center",
                            stype: 'select', searchoptions:{ sopt:['cn'], value: ":All;positive:Positive;neutral:Neutral;negative:Negative", clearSearch: false}
                        },
                    ],
                    viewrecords: true,
                    sortname: 'dated',
                    sortorder: "desc",
                    rowNum: 50,
                    rowList: [10, 50, 100, 100000],
                    autowidth : true,
                    height: '400px',
                    shrinkToFit: true,
                    hidegrid: false,
                    ignoreCase:true,
                },
                filtertoolbar: {
                    stringResult: true, searchOnEnter: false, defaultSearch: 'cn',
                },
                gridapi: {}
            };

            $scope.list_rating_reviews = [];
            $scope.view_rating_review = function(form_obj){
                if(form_obj.$invalid){
                    return;
                }

                var filters = angular.copy($scope.filters);
                filters['bsp_id'] = '{{ bsp.pk }}';

                // Correct filters
                filters['start_date'] =  filters['response_date']['startDate'].format('YYYY-MM-DD');
                filters['end_date'] =  filters['response_date']['endDate'].format('YYYY-MM-DD');
                delete filters['response_date'];

                // --- Get data & display ---
                $scope.ui_flags.loading = true;

                ServiceBspFeedback.get_rating_reviews('{{ request.curr_org.org_uid }}', filters).then(
                    function (response_data) {
                        $scope.ui_flags.loading = false;
                        $scope.ui_flags.loaded = true;

                        var records = response_data.objects;

                        // --- Process data ---
                        for(var i=0;i<records.length;i++){
                            var row = records[i];

                            records[i]['respondent'] = row['user']['full_name'] + ' (' + row['user']['username'] + ')';
                        }
                        // --- /Process data ---

                        $scope.list_rating_reviews = records;

                        $scope.grid_rating_reviews.gridapi.clear();
                        $scope.grid_rating_reviews.gridapi.insert(records);

                        $("#grid_response").jqGrid('setCaption',
                            $("#jqtmpl_grip_response_caption").tmpl({
                                "length": records.length,
                                "filtered": false
                            }).html()
                        );
                    },
                    function(response){
                        $scope.ui_flags.loading = false;

                        if(response.status != -1){
                            $.growl.error({
                                title: '<i class="fa fa-exclamation-triangle"></i> Error!',
                                message: "Something went wrong. Our engineers will be informed."
                            });
                        }else{
                            $.growl.error({
                                title: '<i class="fa fa-signal"></i> Network error!',
                                message: "Please check your internet connection."
                            });
                        }

                    }
                );
            };

        }
        // --- Rating & Reviews ---

        // --- FeedbackResponsesCtrl ---
        function FeedbackResponsesCtrl($scope, ServiceBspFeedback){
            // filters
            $scope.filters_response = {
                "response_date":{
                    "startDate": moment().add(-1, 'months'),
                    "endDate": moment()
                }
            };
            $scope.set_filter_daterange = function(key){
                switch (key){
                    case 'today': {
                            $scope.filters_response["response_date"] = {
                                "startDate": moment(),
                                "endDate": moment()
                            };
                        }break;
                    case 'last7days': {
                            $scope.filters_response["response_date"] = {
                                "startDate": moment().add(-7, 'days'),
                                "endDate": moment()
                            };
                        }break;
                    case 'last30days': {
                            $scope.filters_response["response_date"] = {
                                "startDate": moment().add(-30, 'days'),
                                "endDate": moment()
                            };
                        }break;
                    default: { alert("Invalid date range option!"); }

                }
            };

            // UI
            $scope.ui_flags = {
                loading: false,
                loaded: false
            };

            // Jqgrid
            $scope.grid_responses = {
                gridid: "grid_response",
                pagerid: "grid_response_pager",
                config: {
                    datatype: "local",
                    colNames: [
                        '',
                        'ResponseUID',
                        'DateTime',
                        'Respondent',
                        'Questionnaire',
                        'Rating',
                        'Comment',
                        'Is suspect',
                        'Metadata',
                        ''
                    ],
                    colModel: [
                        { name: 'row_id', index: 'row_id', width: 50, search:false },
                        { name: 'response_uid', index: 'response_uid', width: 40, key:true, hidden:true },
                        { name: 'response_date', index: 'response_date', width: 120,
                            sorttype:'date', formatter: "date", formatoptions: { srcformat: 'Y-m-dTH:i:s', newformat: 'd-M-Y h:i A' },
{#                            searchoptions:{attr:{placeholder:'yyyy-mm-dd'}},#}
                            searchoptions: {
{#                                attr:{placeholder:'yyyy-mm-dd', readonly:'readonly'},#}
                                attr:{ placeholder: 'Select date', readonly:'readonly'},
                                dataInit: function (elem) {
                                    $(elem).datepicker({
{#                                        format: 'dd-M-yyyy',#}
                                        format: 'yyyy-mm-dd',
                                        keyboardNavigation: false,
                                        autoclose: true,
                                        todayHighlight: true,
                                    }).on('changeDate', function(e) {
                                        $('#grid_response')[0].triggerToolbar();
                                    });
                                }
                            }
                        },
                        { name: 'respondent', index: 'respondent', width: 200 },
                        { name: 'form.title', index: 'form.title', width: 150,
                            stype: 'select', searchoptions:{ sopt:['cn'], value: ":All;{% for f in list_feedback_forms %}{{ f.title }}:{{ f.title }}{% if not forloop.last %};{% endif %}{% endfor %}", clearSearch: false}

                        },
                        { name: 'rating', index: 'rating', width: 60, sorttype:'int', align:"center",
                            stype: 'select', searchoptions:{ sopt:['eq'], value: ":All;1:1;2:2;3:3;4:4;5:5", clearSearch: false}
                        },
                        { name: 'comment', index: 'comment', width: 180 },
                        { name: 'suspect_html', index: 'flags.suspect', width: 80, align:"center",
                            stype: 'select', searchoptions:{ sopt:['cn'], value: ":All;true:Yes;false:No", clearSearch: false}
                        },
                        { name: 'meta_icons', index: 'meta_icons', width: 120, search:false, sortable:false },
                        { name: 'actions', index: 'actions', width: 60, search:false, sortable:false },

                    ],
                    viewrecords: true,
{#                    caption:"Responses",#}
                    sortname: 'response_date',
                    sortorder: "desc",
                    rowNum: 50,
                    rowList: [10, 50, 100, 100000],
                    autowidth : true,
                    height: '300px',
                    shrinkToFit: true,
                    hidegrid: false,
                    ignoreCase:true,
                    onSelectRow: function(response_uid) {
                        google.maps.event.trigger($scope.map_markers[response_uid], 'click');
                    }
                },
                filtertoolbar: {
                    stringResult: true, searchOnEnter: false, defaultSearch: 'cn',
                },
                gridapi: {}
            };

            // Map
            $scope.mapOptions = {
                zoom: 4,
                center: new google.maps.LatLng(21, 78),
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                zoomControl:true,
                scaleControl:true,
                streetViewControl:true,
                overviewMapControl:true,
                rotateControl:true,

            };
            $scope.map_markers = {};

            $scope.list_responses = [];
            $scope.view_response_report = function(){
                var filters = angular.copy($scope.filters_response);
                filters['bsp_id'] = '{{ bsp.pk }}';

                // Correct parameters
                for(var key in filters){
                    if(key.includes('__')){
                        var val = filters[key];
                        var new_key = key.replace(/__/g,'.');
                        delete filters[key];
                        filters[new_key] = val;
                    }
                }

                if(filters['response_date']){
                    filters['response_date__gte'] =  filters['response_date']['startDate'].format('YYYY-MM-DD');
                    filters['response_date__lte'] =  filters['response_date']['endDate'].add(1, 'days').format('YYYY-MM-DD');
                    delete filters['response_date'];
                }

                // --- Get data & display ---
                $scope.ui_flags.loading = true;

                ServiceBspFeedback.get_responses('{{ request.curr_org.org_uid }}', filters).then(
                    function (response_data) {
                        $scope.ui_flags.loading = false;
                        $scope.ui_flags.loaded = true;

                        var records = response_data.objects;

                        // --- Process data ---
                        var ENUM_META_ICO = {
                            "map": {
                                "ok": '<i class="fa fa-map-marker list_md_icon meta_icons" data-toggle="tooltip" data-placement="bottom" title="" data-original-title="Has location" onclick="$(\'html, body\').animate({ scrollTop: $(\'#div_map_responses\').offset().top-20 }, \'fast\');"></i>',
                                "none": '<i class="fa fa-map-marker list_md_icon meta_icons_disabled"></i>'
                            },
                            "description_read": {
                                "ok": '<i class="fa fa-eye list_md_icon meta_icons" data-toggle="tooltip" data-placement="bottom" title="" data-original-title="Description was read"></i>',
                                "none": '<i class="fa fa-eye list_md_icon meta_icons_disabled"></i>'
                            },
                            "instructions_read": {
                                "ok": '<i class="fa fa-book list_md_icon meta_icons" data-toggle="tooltip" data-placement="bottom" title="" data-original-title="Instructions were read"></i>',
                                "none": '<i class="fa fa-book list_md_icon meta_icons_disabled"></i>'
                            },
                            "has_ai":{
                                "ok": '<i class="fa fa-android list_md_icon meta_icons" data-toggle="tooltip" data-placement="bottom" title="" data-original-title="Artificial intelligence applied"></i>',
                                "none": '<i class="fa fa-android list_md_icon meta_icons_disabled"></i>'
                            }
                        };

                        for(var i=0;i<records.length;i++){
                            var row = records[i];

                            records[i]['respondent'] = row['user']['user_fullname'] + ' (' + row['user']['username'] + ')';

                            var flags = row['flags'];
                            records[i]["row_id"] = (i+1)+"";
                            records[i]["suspect_html"] = flags['suspect']?'<span class="text-danger"><i class="fa fa-question"></i> Suspect</span>':'';

                            var meta_icons = (row['location']['coordinates']?ENUM_META_ICO["map"]["ok"]:ENUM_META_ICO["map"]["none"])+
                                    (flags['description_read']?ENUM_META_ICO["description_read"]["ok"]:ENUM_META_ICO["description_read"]["none"])
                                    + (flags['instructions_read']?ENUM_META_ICO["instructions_read"]["ok"]:ENUM_META_ICO["instructions_read"]["none"])
                                    + (flags['has_ai']?ENUM_META_ICO["has_ai"]["ok"]:ENUM_META_ICO["has_ai"]["none"]);
                            records[i]["meta_icons"] = meta_icons;

                            records[i]['actions'] = '<a href="{% url 'console_feedback_bsp_response' %}?c={{ request.curr_org.org_uid }}&id='+row['id']+'" class="btn btn-primary btn-xs btn-outline grid_btn" target="_blank">View</a>';
                        }

                        // --- /Process data ---

                        $scope.list_responses = records;
                        var filtered = false;
                        for(var k in filters){
                            if(filters[k]){
                                filtered = true;
                                break;
                            }
                        }

                        $scope.grid_responses.gridapi.clear();
                        $scope.grid_responses.gridapi.insert(records);
                        $("#grid_response").jqGrid('setCaption',
                            $("#jqtmpl_grip_response_caption").tmpl({
                                "length": records.length,
                                "filtered": filtered
                            }).html()
                        );

                        $('.meta_icons').tooltip();
                        $('.tool_tip').tooltip();

                        // --- Map ---
                        $("#div_map_responses").show();
                        google.maps.event.trigger($scope.MAP_RESPONSES, 'resize');

                        // Clear map
                        for(var r_uid in $scope.map_markers){
                            var mrkr = $scope.map_markers[r_uid];
                            mrkr.setMap(null);
                        }
                        $scope.map_markers = {};

                        // Create map
                        var map_bounds = new google.maps.LatLngBounds();
                        var count_points = 0;
                        for(var i=0;i<records.length;i++){
                            var row = records[i];

                            // Create markers
                            var coord = row['location']['coordinates']; //Long, Lat
                            if(coord){
                                var point = new google.maps.LatLng(coord[1], coord[0]);
                                var marker = new MarkerWithLabel({
                                    position: point,
                                    map: $scope.MAP_RESPONSES,
                                    data: $.extend({}, row),
                                    icon: "{% get_static_prefix %}images/markers/marker_response.png",
                                    labelContent: row["row_id"],
                                    labelAnchor: new google.maps.Point(15, 36),
                                    labelClass: "marker_label", // the CSS class for the label
                                    labelInBackground: false,
                                    labelVisible: true
                                });


                                // Marker events
                                var infowindow = new google.maps.InfoWindow({
                                    content: " "
                                });
                                google.maps.event.addListener(marker, 'click', function () {
                                    var content = $("#jqtmpl_map_response_dialogue").tmpl(this.data).html();

                                    infowindow.setContent(content);
                                    infowindow.open($scope.MAP_RESPONSES, this);
                                });


                                $scope.map_markers[row['response_uid']] = marker;
                                map_bounds.extend(point);

                                count_points ++;
                            }
                        }

                        if(count_points) {
                            if (count_points > 1) {
                                $scope.MAP_RESPONSES.fitBounds(map_bounds);
                            } else {
                                $scope.MAP_RESPONSES.panTo(point);
                                $scope.MAP_RESPONSES.setZoom(10);
                            }
                        }
                        // --- Map ---
                    },
                    function(response){
                        $scope.ui_flags.loading = false;

                        if(response.status != -1){
                            $.growl.error({
                                title: '<i class="fa fa-exclamation-triangle"></i> Error!',
                                message: "Something went wrong. Our engineers will be informed."
                            });
                        }else{
                            $.growl.error({
                                title: '<i class="fa fa-signal"></i> Network error!',
                                message: "Please check your internet connection."
                            });
                        }

                    }
                );
            };
        }
        // --- /FeedbackResponsesCtrl ---
    </script>
{% endblock %}