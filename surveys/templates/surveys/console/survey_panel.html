{# Copyright (C) 2017 Feedvay (Gagandeep Singh: singh.gagan144@gmail.com) - All Rights Reserved #}
{# Content in this document can not be copied and/or distributed without the express #}
{# permission of Gagandeep Singh. #}
{% extends 'console/base.html' %}
{% load static commontags %}

{% block head %}
    <!-- Favicon -->
    <link rel="shortcut icon"  href="{% if request.curr_brand %}{{ request.curr_brand.icon.url }}{% else %}{% get_static_prefix %}images/favicon.png{% endif %}" />

    <title page-title></title>

    <style>
        .survey_state{
            line-height: 0;
            font-size: 30px;
            margin-top: 22px;
        }

        .form_section{
            margin-bottom: 30px;
        }
    </style>

    <!-- Templates -->
    <script type="text/ng-template" id="tmpl_summary">
        <div>
            <h2 style="margin-top: 0px;">
                <i class="fa fa-bar-chart"></i>&nbsp;
                Summary
            </h2>
            <hr style="margin-top: 15px;"/>

        </div>
    </script>

    <script type="text/ng-template" id="tmpl_responses">
        <div>
            <h2 style="margin-top: 0px;">
                <i class="fa fa-twitch"></i>&nbsp;
                Responses
            </h2>
            <hr style="margin-top: 15px;"/>

        </div>
    </script>

    <script type="text/ng-template" id="tmpl_visualize">
        <div>
            <h2 style="margin-top: 0px;">
                <i class="fa fa-pie-chart"></i>&nbsp;
                Visualize
            </h2>
            <hr style="margin-top: 15px;"/>

        </div>
    </script>

    <script type="text/ng-template" id="tmpl_edit">
        <div>
            <h2 style="margin-top: 0px;">
                <i class="fa fa-pencil-square-o"></i>&nbsp;
                Review/Edit
            </h2>
            <hr style="margin-top: 15px;"/>

            <p>
                Review or edit your survey. Please note that editing your survey while its live can be critical and
                might take some time to reach devices. You might also receive responses corresponding to old version
                even after saving changes.
            </p>

            <div class="row">
                <div class="col-xs-10">
                    <!-- Edit region -->
                    <div class="tabs-container">
                        <ul class="nav nav-tabs">
                            <li class="active"><a data-toggle="tab" href="#tab_edit_review" onclick="event.preventDefault();">Review</a></li>
                            {% if survey.type == 'simple' %}
                                <li class=""><a data-toggle="tab" href="#tab_edit_form" onclick="event.preventDefault();">Questionnaire</a></li>
                            {% elif survey.type == 'complex' %}
                                <li class=""><a data-toggle="tab" href="#tab_edit_workflow" onclick="event.preventDefault();">Workflow</a></li>
                            {% endif %}
                        </ul>
                        <div class="tab-content">
                            <div id="tab_edit_review" class="tab-pane active">
                                <div class="panel-body">
                                    <!-- General information -->
                                    <form name="form_survey" class="form-horizontal" novalidate>

                                        <div class="form_section">
                                            <h3>
                                                <i class="fa fa-info-circle"></i>&nbsp;
                                                General
                                            </h3>
                                            <hr style="margin: 15px 0px;"/>

                                            <div class="form-group">
                                                <label class="col-sm-2 control-label">Category<span class="required">*</span>:</label>
                                                <div class="col-sm-8">
                                                    <select class="form-control" name="category" ng-model="survey.category" ng-class="{'error': form_survey.category.$invalid}" required>
                                                        <option value="">Please Select</option>
                                                        {% for c in list_categories %}
                                                            <option value="{{ c.id }}">{{ c.name }}</option>
                                                        {% endfor %}
                                                    </select>
                                                    <p class="help-block m-b-none">
                                                        Category to which this survey belongs.
                                                    </p>
                                                    <div ng-messages="form_survey.category.$dirty && form_survey.category.$error" role="alert" class="error_messages">
                                                        <label ng-message="required" class="error">Please select a category.</label>
                                                    </div>
                                                    <label ng-if="flags.val_errors.category" class="error">
                                                        {$ flags.val_errors.category.join(", ") $}
                                                    </label>
                                                </div>
                                            </div>

                                            <div class="hr-line-dashed hr_line_dashed_m10"></div>
                                            <div class="form-group">
                                                <label class="col-sm-2 control-label">Title<span class="required">*</span>:</label>
                                                <div class="col-sm-8">
                                                    <input type="text" class="form-control" name="title" ng-model="survey.title" ng-class="{'error': form_survey.title.$invalid}" required>
                                                    <p class="help-block m-b-none">
                                                        Catchy title for your survey.
                                                    </p>
                                                    <div ng-messages="form_survey.title.$dirty && form_survey.title.$error" role="alert" class="error_messages">
                                                        <label ng-message="required" class="error">Please enter a title.</label>
                                                    </div>
                                                    <label ng-if="flags.val_errors.title" class="error">
                                                        {$ flags.val_errors.title.join(", ") $}
                                                    </label>
                                                </div>
                                            </div>

                                            <div class="hr-line-dashed hr_line_dashed_m10"></div>
                                            <div class="form-group">
                                                <label class="col-sm-2 control-label">Description<span class="required">*</span>:</label>
                                                <div class="col-sm-8">
                                                    <textarea summernote name="description" ng-model="survey.description" config="summernote_config" required></textarea>
                                                    <p class="help-block m-b-none">
                                                        Detailed description about your survey. Use this area to explain what your survey is all about and
                                                        purpose you want to achieve. Your description provides authenticity about your survey to the participants.
                                                    </p>
                                                    <div ng-messages="form_survey.description.$dirty && form_survey.description.$error" role="alert" class="error_messages">
                                                        <label ng-message="required" class="error">Please write something about your survey.</label>
                                                    </div>
                                                    <label ng-if="flags.val_errors.description" class="error">
                                                        {$ flags.val_errors.description.join(", ") $}
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Duration -->
                                        <div class="form_section">
                                            <h3>
                                                <i class="fa fa-calendar"></i>&nbsp;
                                                Duration
                                            </h3>
                                            <hr style="margin: 15px 0px 10px 0px;"/>
                                            <div class="form-group">
                                                <div class="col-sm-6">
                                                    <p class="help-block" style="margin-top: 0px;">
                                                        Date range for which this survey will be live.
                                                    </p>
                                                    <div ng-class="{'input-group':survey.duration.endDate && survey.duration.startDate}">
                                                        <input date-range-picker name="duration" class="form-control date-picker" type="text" ng-model="survey.duration"
                                                           min="daterange_opt.min"
                                                           options="{separator: '  to  ', format: 'DD-MMM-YYYY'}"
                                                           required
                                                        />
                                                        <span class="input-group-addon" ng-if="survey.duration.endDate && survey.duration.startDate">
{#                                                            {$ ((survey.duration.endDate - survey.duration.startDate)/(1000*60*60*24))|number:0 $} day/s#}
                                                            {$ survey.duration.endDate.diff(survey.duration.startDate, 'days')+1 $} day/s
                                                        </span>
                                                    </div>
                                                    <div ng-messages="form_survey.duration.$dirty && form_survey.duration.$error" role="alert" class="error_messages">
                                                        <label ng-message="required" class="error">Please select date range.</label>
                                                    </div>
                                                    <label ng-if="flags.val_errors.start_date || flags.val_errors.end_date" class="error">
                                                        {$ flags.val_errors.start_date.join(", ") $} {$ flags.val_errors.end_date.join(", ") $}
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Audience -->
                                        <div>
                                            <h3>
                                                <i class="fa fa-users"></i>&nbsp;
                                                Audience
                                            </h3>
                                            <hr style="margin: 15px 0px;"/>
                                            <div class="form-group">
                                                <label class="col-sm-2 control-label">Audience type<span class="required">*</span>:</label>
                                                <div class="col-sm-8" style="padding-top: 7px;">
                                                    <p>
                                                        Select the following types of audience that can participate this survey:
                                                    </p>
                                                    <div>
                                                        <div class="radio radio-primary">
                                                            <input type="radio" id="chk_audtype_public" value="public" name="audience_type" ng-model="survey.audience_type" required >
                                                            <label for="chk_audtype_public">
                                                                <span class="semi_bold">Public</span> <br/>
                                                                <small>Survey will be open to public and anyone can respond to it.</small>
                                                            </label>
                                                        </div>
                                                        <div class="radio radio-primary">
                                                            <input type="radio" id="chk_audtype_invited" value="invited" name="audience_type" ng-model="survey.audience_type" required>
                                                            <label for="chk_audtype_invited">
                                                                <span class="semi_bold">Invited</span> <br/>
                                                                <small>
                                                                    Survey will not be visible to public. Only those who have Survey-UID or qrcode can
                                                                    respond to it.
                                                                </small>
                                                            </label>
                                                        </div>
                                                        <div class="radio radio-primary">
                                                            <input type="radio" id="chk_audtype_self" value="self" name="audience_type" ng-model="survey.audience_type" required >
                                                            <label for="chk_audtype_self">
                                                                <span class="semi_bold">Self</span> <br/>
                                                                <small>
                                                                    No one other than you can respond to this survey.
                                                                    Use this when you are conducting survey yourself.
                                                                </small>
                                                            </label>
                                                        </div>
                                                    </div>

                                                    <div ng-messages="form_survey.audience_type.$dirty && form_survey.audience_type.$error" role="alert" class="error_messages">
                                                        <label ng-message="required" class="error">Please select an audience type.</label>
                                                    </div>
                                                    <label ng-if="flags.val_errors.audience_type" class="error">
                                                        {$ flags.val_errors.audience_type.join(", ") $}
                                                    </label>
                                                </div>
                                            </div>

                                        </div>

                                        <!-- Save -->
                                        <div class="hr-line-dashed"></div>
                                        <div class="form-group" style="margin-bottom: 0px !important;">
                                            <div class="col-sm-7">
                                                <div ng-if="flags.error_msg" class="alert alert-danger alert-dismissable" style="padding: 10px 30px 10px 10px;margin-bottom: 20px;">
                                                    <button aria-hidden="true" data-dismiss="alert" class="close" type="button">×</button>
                                                    <i class="fa fa-exclamation-triangle"></i>&nbsp;
                                                    {$ flags.error_msg $}
                                                </div>

                                                <button ladda="flags.submitting" class="btn btn-primary ladda-button" type="button" ng-disabled="form_survey.$invalid" ng-click="submit(form_survey)" data-style="zoom-in">Save</button>
                                                <button class="btn btn-link" type="button" onclick="location.href = location.pathname;">Cancel</button>
                                            </div>
                                        </div>

                                    </form>

                                </div>
                            </div>
                            {% if survey.type == 'simple' %}
                                <div id="tab_edit_form" class="tab-pane">
                                    <div class="panel-body">
                                        <p>
                                            Review or edit questionnaire associated with your survey. Please be save your
                                            changes before proceeding and be careful will updating your questionnaire
                                            as the changes cannot be reverted.
                                        </p>
                                        <p>
                                            <a class="btn btn-primary" href="{% url 'console_survey_simple_form_editor' survey.survey_uid %}" onclick="return confirm('Are you sure you want to leave this page?');">
                                                Edit questionnaire
                                            </a>
                                        </p>
                                    </div>
                                </div>
                            {% elif survey.type == 'complex' %}
                                <div id="tab_edit_workflow" class="tab-pane">
                                    <div class="panel-body">
                                        <p>
                                            Survey workflow
                                        </p>
                                        <p>
                                            {% for ph in survey.surveyphase_set.all %}
                                                <a href="{% url 'console_survey_phase_form_editor' survey.survey_uid ph.id %}">Edit Phase-{{ forloop.counter }}</a><br/>
                                            {% endfor %}
                                        </p>
                                    </div>
                                </div>
                            {% endif %}
                        </div>

                    </div>
                    <!-- /Edit region -->
                </div>
                <div class="col-xs-2" align="center">
                    <!-- Qrcode -->
                    <img src="{{ survey.qrcode.url }}" width="100%;">
                    <br/>
                    <label>Survey-UID:</label> {{ survey.survey_uid }}
                    <!-- /Qrcode -->
                </div>
            </div>
        </div>
    </script>
    <!-- /Templates -->
{% endblock %}

{% block page_header %}
    <div class="row wrapper border-bottom white-bg page-heading">
        <div class="col-xs-11">
            <h2>{{ survey.title }}</h2>
            <ol class="breadcrumb">
                <li>
                    <a href="{% url 'console_home' %}">Home</a>
                </li>
                <li>
                    <a href="{% url 'console_surveys' %}">Surveys</a>
                </li>
                <li class="active">
                    {{ survey.title }}
                </li>
            </ol>
        </div>
        <div class="col-xs-1" align="center">
            <!-- Status -->

            {% if survey.status == SURVEY.ST_DRAFT %}
                <div style="color: #b7b7b7;">
                    <div class="survey_state">
                        <i class="fa fa-file-text-o"></i>
                    </div>
                    <div>Draft</div>
                </div>
            {% elif survey.status == SURVEY.ST_READY %}
                {% if survey.start_date <= now and now <= survey.end_date %}
                    <div class="text-success">
                        <div class="survey_state">
                            <i class="fa fa-play"></i>
                        </div>
                        <div>Live</div>
                    </div>
                {% elif now > survey.end_date %}
                    <div class="text-success">
                        <div class="survey_state">
                            <i class="fa fa-check-circle"></i>
                        </div>
                        <div>Completed</div>
                    </div>
                {% else %}
                    <div class="text-info">
                        <div class="survey_state">
                            <i class="fa fa-check"></i>
                        </div>
                        <div>Ready</div>
                    </div>
                {% endif %}
            {% elif survey.status == SURVEY.ST_PAUSED %}
                <div class="text-warning">
                    <div class="survey_state">
                        <i class="fa fa-pause"></i>
                    </div>
                    <div>Paused</div>
                </div>
            {% elif survey.status == SURVEY.ST_STOPPED %}
                <div class="text-danger">
                    <div class="survey_state">
                        <i class="fa fa-stop"></i>
                    </div>
                    <div>Stopped</div>
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block content %}

    <div class="wrapper_admin_content" ng-controller="MainCtrl">
        <table class="table_tab_admin">
            <tr>
                <td class="admin_tabs" valign="top">
                    <div class="list-group list_group_tabs" >
                        <a ui-sref="summary" class="list-group-item" ng-class="{'active': $state.current.name=='summary'}">
                            <i class="fa fa-bar-chart-o list_md_icon"></i>
                            Summary
                        </a>
                        <a ui-sref="responses" class="list-group-item" ng-class="{'active': $state.current.name=='responses'}">
                            <i class="fa fa-twitch list_md_icon"></i>
                            Responses
                        </a>
                        <a ui-sref="visualize" class="list-group-item" ng-class="{'active': $state.current.name=='visualize'}">
                            <i class="fa fa-pie-chart list_md_icon"></i>
                            Visualize
                        </a>
                        <a ui-sref="edit" class="list-group-item" ng-class="{'active': $state.current.name=='edit'}">
                            <i class="fa fa-pencil-square-o list_md_icon"></i>
                            Review/Edit
                        </a>
                    </div>
                </td>
                <td class="admin_content" valign="top">
                    <!-- Partial view div -->
                    <div ui-view></div>
                    <!-- Partial view div -->
                </td>
            </tr>
        </table>
    </div>

{% endblock %}

{% block scripts %}
    <script src="{% get_static_prefix %}ui/js/ui-router/angular-ui-router.min.js"></script>

    <script>
        'use strict';

        var APP = angular.module('{{ app_name }}',[
            'feedvay.uiapp',
            'feedvay.common',
            'feedvay.watchdog',

            'ngCookies',
            'ngMessages',
            'ngSanitize',
            'ui.router',                    // Routing
            'oc.lazyLoad',                  // ocLazyLoad
            'ui.bootstrap',
            'angular-ladda'
        ])
        .config(function($interpolateProvider, $httpProvider, $stateProvider, $urlRouterProvider, $ocLazyLoadProvider) {
            $interpolateProvider.startSymbol('{$');
            $interpolateProvider.endSymbol('$}');

            $httpProvider.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest';
            $httpProvider.defaults.headers.post['Content-Type'] = 'application/x-www-form-urlencoded;charset=utf-8';

            // ----- Routing -----
            $urlRouterProvider.otherwise("/summary");   // Default state to load

            $ocLazyLoadProvider.config({
                // Set to true if you want to see what and when is dynamically loaded
                debug: false
            });

            $stateProvider
                .state('summary', {
                    url: "/summary",
                    templateUrl: "tmpl_summary",
                    data: { pageTitle: 'Summary - {{ survey.title }}' },
{#                    controller: DetailsCtrl,#}
{#                    resolve: {#}
{#                        loadPlugin: function ($ocLazyLoad) {#}
{#                            return $ocLazyLoad.load([#}
{#                                {#}
{#                                    files:['{% get_static_prefix %}lib/vibrantjs/Vibrant.js']#}
{#                                },#}
{#                                {#}
{#                                    name: 'colorpicker.module',#}
{#                                    files: [#}
{#                                        '{% get_static_prefix %}ui/css/plugins/colorpicker/colorpicker.css',#}
{#                                        '{% get_static_prefix %}ui/js/plugins/colorpicker/bootstrap-colorpicker-module.js'#}
{#                                    ]#}
{#                                }#}
{#                            ]);#}
{#                        }#}
{#                    }#}
                })
                .state('responses', {
                    url: "/responses",
                    templateUrl: "tmpl_responses",
                    data: { pageTitle: 'Responses - {{ survey.title }}' },
{#                    controller: OwnershipCtrl,#}
                })
                .state('visualize', {
                    url: "/visualize",
                    templateUrl: "tmpl_visualize",
                    data: { pageTitle: 'Visualize - {{ survey.title }}' },
{#                    controller: ControlsCtrl,#}
                })
                .state('edit', {
                    url: "/edit",
                    templateUrl: "tmpl_edit",
                    data: { pageTitle: 'Review/Edit - {{ survey.title }}' },
                    controller: ReviewEditCtrl,
                    resolve: {
                        loadPlugin: function ($ocLazyLoad) {
                            return $ocLazyLoad.load([
                                {
                                    serie: true,
                                    files: [
                                        '{% get_static_prefix %}ui/js/plugins/daterangepicker/daterangepicker.js',
                                        '{% get_static_prefix %}ui/css/plugins/daterangepicker/daterangepicker-bs3.css'
                                    ]
                                },
                                {
                                    name: 'daterangepicker',
                                    files: ['{% get_static_prefix %}ui/js/plugins/daterangepicker/angular-daterangepicker.js']
                                }
                            ]);
                        }
                    }
                })



        })
        .run(function($rootScope, $http, $cookies, $state) {
            $http.defaults.headers.post['X-CSRFToken'] = $cookies.csrftoken;

            $http.defaults.xsrfCookieName = 'csrftoken';
            $http.defaults.xsrfHeaderName = 'X-CSRFToken';

            // ----- Routing -----
            $rootScope.$state = $state;

            $rootScope.$on('$stateChangeError', function (event, toState, toParams, fromState, fromParams, error) {
                event.preventDefault();
                //console.log(error);

                if(error.status == -1){
                    $.growl.error({
                        title: '<i class="fa fa-signal"></i> Network error!',
                        message: "Please check your internet connection."
                    });
                }else{
                    $.growl.error({
                        title: '<i class="fa fa-exclamation-triangle"></i> Error!',
                        message: "Something went wrong. Our engineers will be informed."
                    });
                }

            });

            // ----- Survey -----
            $rootScope.survey = {
                type: "{{ survey.type }}",
                category: "{{ survey.category_id }}",
                title: "{{ survey.title }}",
                description: "{{ survey.description|safe }}",
                duration: {
                    startDate: moment('{{ survey.start_date|date:"Y-m-d" }}', 'YYYY-MM-DD'),
                    endDate: moment('{{ survey.end_date|date:"Y-m-d" }}', 'YYYY-MM-DD'),
                },
                audience_type: "{{ survey.audience_type }}",
            };

            $rootScope.summernote_config = SUMMERNOTE_CONFIG;

        });


        APP.controller('MainCtrl', function($scope){

        });

        // ========== State Controllers ==========
        // ----- Review/Edit -----
        function ReviewEditCtrl($rootScope, $scope, $http, $window){
            $scope.daterange_opt = {
                min: moment.min(moment('{{ survey.start_date|date:"Y-m-d" }}', 'YYYY-MM-DD'), moment()).format('YYYY-MM-DD')
            };

            $scope.flags = {
                submitting: false,
                error_msg: null,
                val_errors: null
            };

            $scope.submit = function(form_obj){
                if(form_obj.$invalid) {
                    return false;
                }

                $scope.flags.submitting = true;
                $scope.flags.error_msg = null;
                $scope.flags.val_errors = null;

                var data = angular.copy($rootScope.survey);
                data['start_date'] = data['duration']['startDate'].format('YYYY-MM-DD');
                data['end_date'] = data['duration']['endDate'].format('YYYY-MM-DD');
                delete data['duration'];

                $http.post(
                    "/console/surveys/{{ survey.survey_uid }}/save/",
                    $.param(data)
                )
                .success(function (response, status, headers, config) {
                    if(response.status=='success'){
                        $window.location.reload();
                    }else{
                        $scope.flags.submitting = false;
                        $scope.flags.error_msg = response.message;
                        $scope.flags.val_errors = response.errors;
                    }
                })
                .error(function (response, status, headers, config) {
                    $scope.flags.submitting = false;

                    if(status != -1){
                        $scope.flags.error_msg = 'Something went wrong. Our engineers will be informed.'
                    }else{
                        $.growl.error({
                            title: '<i class="fa fa-signal"></i> Network error!',
                            message: "Please check your internet connection."
                        });
                    }
                });

            }
        }
        // ----- /Review/Edit -----
        // ========== /State Controllers ==========

    </script>
{% endblock %}