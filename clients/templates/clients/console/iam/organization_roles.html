{# Copyright (C) 2017 Feedvay (Gagandeep Singh: singh.gagan144@gmail.com) - All Rights Reserved #}
{# Content in this document can not be copied and/or distributed without the express #}
{# permission of Gagandeep Singh. #}
{% extends 'console/base.html' %}
{% load static commontags %}

{% block head %}
    <!-- Favicon -->
    <link rel="shortcut icon"  href="{{ request.curr_org.icon.url }}" />

    <title>Roles | {{ request.curr_org.name }}</title>
{% endblock %}

{% block page_header %}
    <div class="row wrapper border-bottom white-bg page-heading">
        <div class="col-xs-8">
            <h2>
                <i class="fa fa-user"></i>
                Roles
            </h2>
            <ol class="breadcrumb">
                <li>
                    <a href="{% url 'console_org_home' %}?c={{ request.curr_org.org_uid }}">Home</a>
                </li>
                <li>
                    IAM
                </li>
                <li class="active">
                    Roles
                </li>
            </ol>
        </div>
        {% if request.permissions|has_permission:"accounts.organizationrole.add_organizationrole" %}
        <div class="col-xs-4">
            <div class="title-action" style="padding-top: 20px !important;">
                <a href="{% url 'console_iam_organization_role_new' %}?c={{ request.curr_org.org_uid }}" class="btn btn-primary">
                    <i class="fa fa-plus"></i>
                    <span class="mobile_hide">&nbsp;Add role</span>
                </a>
            </div>
        </div>
        {% endif %}
    </div>
{% endblock %}

{% block content %}
    <div class="wrapper wrapper-content" ng-cloak>
        <div ng-controller="MainCtrl">

            <div ng-if="ui_flags.state==ST_AJAX.LOADING" class="loading_big white-bg" align="center" valign="middle">
                <img src="{% get_static_prefix %}images/loading/spinner_1.gif" style="height: 40px">
                <h3 style="margin-top: 20px;font-weight: normal;">Loading roles ...</h3>
            </div>

            <div ng-if="ui_flags.state==ST_AJAX.ERROR" class="alert alert-danger">
                <table style="width: 100%">
                    <tr>
                        <td valign="top" style="width: 90px;">
                            <i class="fa fa-exclamation-triangle" style="font-size: 60px;"></i>
                        </td>
                        <td valign="top">
                            <h2 style="margin-top: 0px;">Error!</h2>
                            <div>
                                {$ ui_flags.error_msg $}
                            </div>
                        </td>
                    </tr>
                </table>
            </div>

            <div ng-if="ui_flags.state==ST_AJAX.COMPLETED">
                <div ng-if="list_org_roles.length==0" class="alert alert-info">
                    <table style="width: 100%">
                        <tr>
                            <td valign="top" style="width: 90px;">
                                <i class="fa fa-info-circle" style="font-size: 80px;"></i>
                            </td>
                            <td valign="top">
                                <h2 style="margin-top: 0px;">No roles!</h2>
                                <div>
                                    Either your organization has not added any roles yet or you do not have access over any roles.

                                    {% if request.permissions|has_permission:"accounts.organizationrole.add_organizationrole" %}
                                        <div >
                                            Click below button to add new role in your organization:<br/><br/>
                                            <a href="{% url 'console_iam_organization_role_new' %}?c={{ request.curr_org.org_uid }}" class="btn btn-info btn-xs">
                                                <i class="fa fa-plus"></i>
                                                <span class="mobile_hide">&nbsp;Add role</span>
                                            </a>
                                        </div>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>


                <style>
                    .project-title{
                        min-width: 250px;
                        font-size: 17px;
                    }

                    .project-title > a:hover{
                        text-decoration: underline;
                    }
                </style>
                <div ng-if="list_org_roles.length" class="ibox">
                    <div class="ibox-content">
                        <div class="row m-b-sm m-t-sm">
                            <div class="col-md-12">
                                <div class="input-group">
                                    <span class="input-group-addon">
                                        <span class="semi_bold">{$ list_org_roles.length $}</span> Role<span ng-if="list_org_roles.length>1">s</span>
                                    </span>
                                    <input type="text" ng-model="searchText" placeholder="Search" class="input-sm form-control">
                                </div>
                            </div>
                        </div>

                        <div class="project-list">
                            {% with can_change=request.permissions|has_permission:"accounts.organizationrole.change_organizationrole" %}
                                <table class="table table-hover" style="margin-bottom: 0px;">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th style="width: 100px;" align="right">Permissions</th>
                                            <th style="width: 200px;">Created by</th>
                                            <th style="width: 200px;">Created on</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr ng-repeat="role in list_org_roles|orderBy:'name'|filter: searchText">
                                            <td class="project-title">
                                                {% if can_change %}
                                                    <a ng-href="{$ '{% url 'console_iam_organization_role_edit' 9999 %}'.replace('9999', role.id) $}?c={{ request.curr_org.org_uid }}">{$ role.name $}</a>
                                                {% else %}
                                                    {$ role.name $}
                                                {% endif %}
                                            </td>
                                            <td align="right">
                                                {$ role.count_permissions $}
                                            </td>
                                            <td>
                                                {$ role.created_by.first_name $} {$ role.created_by.last_name $}
                                            </td>
                                            <td>
                                                {$ role.created_on|date:"d-MMM-yyyy h:m a" $}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            {% endwith %}
                        </div>
                    </div>
                </div>

            </div>

        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script src="{% get_static_prefix %}apps/clients/iam.js"></script>
    <script>
        'use strict';

        var APP = angular.module('{{ app_name }}',[
            'feedvay.watchdog',
            'feedvay.iam',

            'ngCookies',
            'ui.bootstrap'
        ])
        .run(function($rootScope, $http, $cookies) {
            $http.defaults.headers.post['X-CSRFToken'] = $cookies.csrftoken;

            $http.defaults.xsrfCookieName = 'csrftoken';
            $http.defaults.xsrfHeaderName = 'X-CSRFToken';

            $rootScope.ST_AJAX = ST_AJAX;
        })
        .config(function($interpolateProvider, $httpProvider) {
            $interpolateProvider.startSymbol('{$');
            $interpolateProvider.endSymbol('$}');

            $httpProvider.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest';
            $httpProvider.defaults.headers.post['Content-Type'] = 'application/x-www-form-urlencoded;charset=utf-8';
        });

        APP.controller('MainCtrl', function($scope, ServiceOrgRoles){
            $scope.ui_flags = {
                state: ST_AJAX.LOADING,
                error_msg: null
            };

            $scope.list_org_roles = [];

            // Get all roles
            ServiceOrgRoles.get('{{ request.curr_org.org_uid }}').then(
                function (response_data){
                    $scope.ui_flags.state = ST_AJAX.COMPLETED;
                    $scope.list_org_roles = response_data;
                },
                function(response){
                    $scope.ui_flags.state = ST_AJAX.ERROR;

                    if(response.status != -1){
                        $scope.ui_flags.error_msg = "Something went wrong. Our engineers will be informed.";
                    }else{
                        $scope.ui_flags.error_msg = "Please check your internet connection.";
                    }

                }
            );

        });
    </script>

{% endblock %}