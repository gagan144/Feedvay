{# Copyright (C) 2017 Feedvay (Gagandeep Singh: singh.gagan144@gmail.com) - All Rights Reserved #}
{# Content in this document can not be copied and/or distributed without the express #}
{# permission of Gagandeep Singh. #}
{% extends 'console/base.html' %}
{% load static commontags %}

{% block head %}
    <!-- Favicon -->
    <link rel="shortcut icon" href="{% if request.curr_brand %}{{ request.curr_brand.icon.url }}{% else %}{% get_static_prefix %}images/favicon.png{% endif %}"/>

    <title page-title></title>

    <link href="{% get_static_prefix %}ui/css/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <link href="{% get_static_prefix %}ui/css/plugins/daterangepicker/daterangepicker-bs3.css" rel="stylesheet">
    <link href="{% get_static_prefix %}ui/css/plugins/datapicker/datepicker3.css" rel="stylesheet">

    <style>
        .survey_state {
            line-height: 0;
            font-size: 30px;
            margin-top: 22px;
        }

        .meta_icons{
            cursor: pointer;
        }

        .meta_icons_disabled{
            color: #e2e2e2;
        }

        .marker_label {
            color: #ffffff;
            font-family: "Lucida Grande", "Arial", sans-serif;
            font-size: 14px;
            text-align: center;
            width: 30px;
            padding-top: 3px;
{#            border: solid 1px red;#}
        }

    </style>

    <!-- Templates -->
    <script type="text/ng-template" id="tmpl_summary">
        <div>
            <h2 style="margin-top: 0px;">
                <i class="fa fa-bar-chart"></i>&nbsp;
                Summary
            </h2>
            <hr style="margin-top: 15px;"/>

            <table style="width: 100%">
                <tr>
                    <td style="min-width: 400px;padding-right: 10px;" valign="top">
                        <!-- Alert -->
                        {% if survey.status == SURVEY.ST_DRAFT %}
                            <div class="alert alert-warning">
                                <table style="width: 100%;">
                                    <tr>
                                        <td style="width: 50px" valign="top">
                                            <i class="fa fa-exclamation-circle" style="font-size: 35px;"></i>
                                        </td>
                                        <td>
                                            <strong>Caution!</strong>
                                            Your survey is in draft state. This means that you are still editing your
                                            survey and it
                                            is not live. Kindly complete your survey and click 'Go live' button to make
                                            it live.
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        {% elif survey.status == SURVEY.ST_PAUSED %}
                            <div class="alert alert-warning">
                                <table style="width: 100%;">
                                    <tr>
                                        <td style="width: 50px" valign="top">
                                            <i class="fa fa-exclamation-triangle" style="font-size: 35px;"></i>
                                        </td>
                                        <td>
                                            <strong>Caution!</strong>
                                            Your survey is paused and is no longer available to be responded. Please
                                            click 'Go live!' button to mark it live. Also make sure you check survey
                                            duration before you go live.
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        {% endif %}
                        <!-- /Alert -->

                        {% if survey.status != SURVEY.ST_DRAFT %}
                        <!-- Summary -->
                        <div ng-if="ui_flags.loading" align="center" valign="middle" style="height: 200px;border: dashed 1px;padding-top: 50px;">
                            <img src="{% get_static_prefix %}images/loading/spinner_1.gif" style="height: 40px">
                            <h3 style="margin-top: 20px;font-weight: normal;">Loading summary ...</h3>
                        </div>

                        <div class="alert alert-danger" ng-if="ui_flags.error">
                            <table style="width: 100%;">
                                <tr>
                                    <td style="width: 50px" valign="top">
                                        <i class="fa fa-exclamation-triangle" style="font-size: 35px;"></i>
                                    </td>
                                    <td valign="middle">
                                        {$ ui_flags.error_msg $}
                                    </td>
                                </tr>
                            </table>
                        </div>

                        <div ng-if="!ui_flags.loading && !ui_flags.error">

                            <div class="alert alert-info" ng-if="data_dashboard.total==0">
                                <table style="width: 100%;">
                                    <tr>
                                        <td style="width: 50px" valign="top">
                                            <i class="fa fa-comments-o" style="font-size: 35px;"></i>
                                        </td>
                                        <td valign="middle">
                                            <strong>No response!</strong>
                                            <br/>No responses has been submitted yet for this survey. The summary will
                                            be visible once the responses are recieved.
                                        </td>
                                    </tr>
                                </table>
                            </div>

                            <div ng-if="data_dashboard.total">
                                <!-- Responses chart -->
                                <div id="div_chart">
                                    <canvas linechart options="data_dashboard.trend_chart.options" data="data_dashboard.trend_chart.data" height="70" responsive=true ></canvas>
                                </div>
                                <!-- /Responses chart -->

                                <!-- Metrics -->
                                <div style="margin-top: 20px;">
                                    <div class="row" ng-if="data_dashboard.total">
                                        <div class="col-md-4">
                                            <div class="widget style1 text-default border-top-bottom border-left-right border-size-sm">
                                                <div class="row">
                                                    <div class="col-xs-4">
                                                        <i class="fa fa-calendar-o fa-4x"></i>
                                                    </div>
                                                    <div class="col-xs-8 text-right">
                                                        <span> Today responses </span>
                                                        <h2 class="font-bold">{$ data_dashboard.count_today|number $}</h2>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="widget style1 text-primary border_primary">
                                                <div class="row">
                                                    <div class="col-xs-4">
                                                        <i class="fa fa-comments-o fa-4x"></i>
                                                    </div>
                                                    <div class="col-xs-8 text-right">
                                                        <span> Total responses </span>
                                                        <h2 class="font-bold">{$ data_dashboard.total|number $}</h2>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="widget style1 text-danger border_danger">
                                                <div class="row">
                                                    <div class="col-xs-4">
                                                        <i class="fa fa-question fa-4x"></i>
                                                    </div>
                                                    <div class="col-xs-8 text-right">
                                                        <span> Total suspects </span>
                                                        <h2 class="font-bold">{$ data_dashboard.count_suspects|number $}</h2>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- /Metrics -->
                            </div>

                        </div>
                        <!-- /Summary -->
                        {% endif %}

                    </td>
                    <td style="width: 220px; padding: 0px 10px 10px 10px;" valign="top">
                        {% if survey.status == SURVEY.ST_STOPPED %}
                            <div class="alert alert-danger">
                                <h2 style="margin-top: 20px;">
                                    <i class="fa fa-stop"></i>&nbsp;Stopped
                                </h2>

                                <p>
                                    Your survey is stopped and is no longer active. You cannot revert this survey and
                                    will no longer receive any responses. However, you may can still
                                    view responses and analyze them.
                                </p>
                            </div>
                        {% else %}
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <i class="fa fa-cogs"></i>&nbsp;
                                    Control
                                </div>
                                <div class="panel-body" style="text-align: center;font-size: 11px;">
                                    {% if survey.status == SURVEY.ST_DRAFT %}
                                        <div>
                                            <p>
                                                If you have ready with your survey,
                                                please click below button to make it live. Survey will automatically
                                                be available as per the survey duration.
                                            </p>
                                            <button type="button" class="btn btn-block btn-info"
                                                    ng-click="survey_transit('ready')">
                                                Go live!
                                            </button>
                                        </div>
                                    {% endif %}

                                    {% if survey.status == SURVEY.ST_PAUSED %}
                                        <div>
                                            <p>
                                                If you want to resume your survey and go live again,
                                                please click below button.
                                            </p>
                                            <button type="button" class="btn btn-block btn-info"
                                                    ng-click="survey_transit('resume')">
                                                Resume
                                            </button>
                                        </div>
                                    {% endif %}

                                    {% if survey.status == SURVEY.ST_READY %}
                                        <div>
                                            <p>
                                                If you wish to pause your survey for some time, click the below button.
                                                You can resume it later.
                                            </p>
                                            <button type="button" class="btn btn-block btn-warning"
                                                    ng-click="survey_transit('pause')">
                                                <i class="fa fa-pause"></i>&nbsp;&nbsp;Pause
                                            </button>
                                        </div>
                                    {% endif %}

                                    {% if survey.status == SURVEY.ST_READY or survey.status == SURVEY.ST_PAUSED %}
                                        <div style="margin-top: 15px;">
                                            <p>
                                                If your survey is no longer valid and you want to permanently stop it,
                                                you can do so by
                                                clicking below button. This action is <b>irreversible</b> and you cannot
                                                resume it.
                                            </p>
                                            <button type="button" class="btn btn-block btn-danger"
                                                    ng-click="survey_transit('stop')">
                                                <i class="fa fa-stop"></i>&nbsp;&nbsp;Stop
                                            </button>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Qrcode -->
                            <div align="center">
                                <img src="{{ survey.qrcode.url }}" class="img-thumbnail image_loading" width="100%;">
                                <br/>
                                <label>Survey-UID:</label> {{ survey.survey_uid }}
                            </div>
                            <!-- /Qrcode -->
                        {% endif %}
                    </td>
                </tr>
            </table>
        </div>
    </script>

    <script type="text/ng-template" id="tmpl_responses">
        <div>
            <h2 style="margin-top: 0px;">
                <i class="fa fa-comments-o"></i>&nbsp;
                Responses
            </h2>
            <hr style="margin-top: 15px;"/>

            <!-- Filters -->
            <div class="panel panel-default">
                <div class="panel-heading">
                    <i class="fa fa-filter"></i> Filters
                </div>
                <div class="panel-body">
                    <form role="form" class="form-horizontal" novalidate>
                        <div class="row">
                            <div class="col-xs-5">
                                <label>Date range:</label>
                                <input date-range-picker name="response_date"
                                       class="form-control input-sm date-picker" type="text"
                                       ng-model="filters_response.response_date"
                                       options="{separator: '  to  ', format: 'DD-MMM-YYYY'}"
                                       placeholder="Select a date range to filter responses"
                                       required
                                />
                            </div>
                            <div class="col-xs-5">
                                <label>Suspect?</label>
                                <div>
                                    <div class="radio radio-danger radio-inline">
                                        <input type="radio" id="rd_suspect_true" value="1" name="flags__suspect" ng-model="filters_response.flags__suspect" required>
                                        <label for="rd_suspect_true">Yes</label>
                                    </div>
                                    <div class="radio radio-success radio-inline">
                                        <input type="radio" id="rd_suspect_false" value="0" name="flags__suspect" ng-model="filters_response.flags__suspect" required>
                                        <label for="rd_suspect_false">No</label>
                                    </div>

                                    <div class="radio radio-inline" style="padding-left: 5px;">
                                        |
                                        <button class="btn btn-link btn-xs" ng-click="filters_response.flags__suspect=undefined;">
                                            <i class="fa fa-times"></i> Clear
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="hr-line-dashed hr_line_dashed_m10"></div>
                        <div>
                            <button type="button" class="btn btn-primary btn-sm ladda-button" ng-click="view_response_report()" ladda="ui_flags.loading" data-style="zoom-in">
                                <i class="fa fa-search"></i>&nbsp;&nbsp;View
                            </button>
                        </div>

                    </form>
                </div>
            </div>
            <!-- /Filters -->

            <div ng-show="ui_flags.loaded">
                <!-- Response grid -->
                <ng-jqgrid
                        config="grid_responses.config"
                        modeldata="list_responses"
                        gridid="{$ grid_responses.gridid $}"
                        pagerid="{$ grid_responses.pagerid $}"
                        api="grid_responses.gridapi"
                        filtertoolbar="{stringResult: true, searchOnEnter: false, defaultSearch: 'cn'}"
                ></ng-jqgrid>
                <!-- /Response grid -->
            </div>

            {% if has_gps_enabled %}
                <!-- Map -->
                <section id="div_map_responses" style="margin-top: 30px;display:none;">
                    <div ui-map="MAP_RESPONSES" ui-options="mapOptions" class="google-map" style="height: 550px;" ></div>
                </section>
                <!-- /Map -->
            {% endif %}


        </div>
    </script>

    <script type="text/ng-template" id="tmpl_visualize">
        <div>
            <h2 style="margin-top: 0px;">
                <i class="fa fa-pie-chart"></i>&nbsp;
                Visualize
            </h2>
            <hr style="margin-top: 15px;"/>

        </div>
    </script>

    <script type="text/ng-template" id="tmpl_edit">
        <div>
            <h2 style="margin-top: 0px;">
                <i class="fa fa-pencil-square-o"></i>&nbsp;
                Review/Edit
            </h2>
            <hr style="margin-top: 15px;"/>

            <p>
                Review or edit your survey. Please note that editing your survey while its live can be critical and
                might take some time to reach devices. You might also receive responses corresponding to old version
                even after saving changes.
            </p>

            <div class="row">
                <div class="col-xs-10">
                    <!-- Edit region -->
                    <div class="tabs-container">
                        <ul class="nav nav-tabs">
                            <li class="active"><a data-toggle="tab" href="#tab_edit_review"
                                                  onclick="event.preventDefault();">Review</a></li>
                            {% if survey.type == 'simple' %}
                                <li class=""><a data-toggle="tab" href="#tab_edit_form"
                                                onclick="event.preventDefault();">Questionnaire</a></li>
                            {% elif survey.type == 'complex' %}
                                <li class=""><a data-toggle="tab" href="#tab_edit_workflow"
                                                onclick="event.preventDefault();">Workflow</a></li>
                            {% endif %}
                        </ul>
                        <div class="tab-content">
                            <div id="tab_edit_review" class="tab-pane active">
                                <div class="panel-body">
                                    <!-- General information -->
                                    <form name="form_survey" class="form-horizontal" novalidate>
                                        <div ng-include="'{% get_static_prefix %}partials/surveys/create_edit_survey.html'" ng-init="ACTION='edit'"></div>
                                    </form>
                                </div>
                            </div>
                            {% if survey.type == 'simple' %}
                                <div id="tab_edit_form" class="tab-pane">
                                    <div class="panel-body">
                                        <p>
                                            Review or edit questionnaire associated with your survey. Please be save
                                            your
                                            changes before proceeding and be careful will updating your questionnaire
                                            as the changes cannot be reverted.
                                        </p>

                                        <p>
                                            <a class="btn btn-primary"
                                               href="{% url 'console_survey_simple_form_editor' survey.survey_uid %}"
                                               onclick="return confirm('Are you sure you want to leave this page?');">
                                                Edit questionnaire
                                            </a>
                                        </p>
                                    </div>
                                </div>
                            {% elif survey.type == 'complex' %}
                                <div id="tab_edit_workflow" class="tab-pane">
                                    <div class="panel-body">
                                        <p>
                                            Survey workflow
                                        </p>

                                        <p>
                                            {% for ph in survey.surveyphase_set.all %}
                                                <a href="{% url 'console_survey_phase_form_editor' survey.survey_uid ph.id %}">Edit
                                                    Phase-{{ forloop.counter }}</a><br/>
                                            {% endfor %}
                                        </p>
                                    </div>
                                </div>
                            {% endif %}
                        </div>

                    </div>
                    <!-- /Edit region -->
                </div>
                <div class="col-xs-2" align="center">
                    <!-- Qrcode -->
                    <img src="{{ survey.qrcode.url }}" class="img-thumbnail image_loading" width="100%;">
                    <br/>
                    <label>Survey-UID:</label> {{ survey.survey_uid }}
                    <!-- /Qrcode -->
                </div>
            </div>
        </div>
    </script>
    <!-- /Templates -->

    <!-- Jquery templates -->
    {% if has_gps_enabled %}
        <script id="jqtmpl_map_response_dialogue" type="text/x-jquery-tmpl">
            <div>
                <table style="width: 220px;margin-top:7px;">
                    <tr>
                        <td style="width: 55px;" valign="top">
                            <i class="fa fa fa-comments-o text-primary" style="font-size: 50px;"></i>
                        </td>
                        <td valign="top" style="padding-left:10px;">
                            <h3 style="margin-top: 0px;">
                                ${user.user_fullname}<br/>
                                <small>${user.username}</small>
                            </h3>

                            <div style="font-size: 11px;">
                                <div style="margin-bottom:15px;">
                                    On ${moment(response_date).format("DD-MMM-YYYY hh:mm A")}
                                </div>

                                {% templatetag openvariable %}if flags.suspect{% templatetag closevariable %}
                                    <div class="text-danger" style="margin-bottom:15px;">
                                        <i class="fa fa-question text-danger"></i> <span >Suspect</span>
                                    </div>
                                {% templatetag openvariable %}/if{% templatetag closevariable %}

                                <a href="/console/surveys/{{ survey.survey_uid }}/response/${response_uid}/" target="_blank" class="btn btn-primary btn-xs">View</a>
                            </div>

                        </td>
                    </tr>
                </table>
    {#            {% templatetag openvariable %}response_uid{% templatetag closevariable %}#}
            </div>
        </script>
    {% endif %}

    <script id="jqtmpl_grip_response_caption" type="text/x-jquery-tmpl">
        <div>
            <b class="text-primary">${length}</b>&nbsp;&nbsp;Responses
            {% templatetag openvariable %}if filtered{% templatetag closevariable %}
                <small style="font-size: 10px;">(Filtered)</small>
            {% templatetag openvariable %}/if{% templatetag closevariable %}
        </div>
    </script>
    <!-- /Jquery templates -->
{% endblock %}

{% block page_header %}
    <div class="row wrapper border-bottom white-bg page-heading">
        <div class="col-xs-11">
            <h2>
                {{ survey.title }}
                <small style="font-size: 12px;margin-left: 10px;">({{ survey.start_date|date:"d-M-Y" }} to {{ survey.end_date|date:"d-M-Y" }})</small>
            </h2>
            <ol class="breadcrumb">
                <li>
                    <a href="{% url 'console_home' %}">Home</a>
                </li>
                <li>
                    <a href="{% url 'console_surveys' %}">Surveys</a>:
                    &nbsp;<span class="text-primary">{{ survey.title }}</span>
                </li>
            </ol>
        </div>
        <div class="col-xs-1" align="center">
            <!-- Status -->
            {% if survey.status == SURVEY.ST_DRAFT %}
                <div style="color: #b7b7b7;">
                    <div class="survey_state">
                        <i class="fa fa-file-text-o"></i>
                    </div>
                    <div>Draft</div>
                </div>
            {% elif survey.status == SURVEY.ST_READY %}
                {% if survey.start_date <= now.date and now.date <= survey.end_date %}
                    <div class="text-success">
                        <div class="survey_state">
                            <i class="fa fa-play"></i>
                        </div>
                        <div>Live</div>
                    </div>
                {% elif now.date > survey.end_date %}
                    <div class="text-success">
                        <div class="survey_state">
                            <i class="fa fa-check-circle"></i>
                        </div>
                        <div>Completed</div>
                    </div>
                {% else %}
                    <div class="text-info">
                        <div class="survey_state">
                            <i class="fa fa-check"></i>
                        </div>
                        <div>Ready</div>
                    </div>
                {% endif %}
            {% elif survey.status == SURVEY.ST_PAUSED %}
                <div class="text-warning">
                    <div class="survey_state">
                        <i class="fa fa-pause"></i>
                    </div>
                    <div>Paused</div>
                </div>
            {% elif survey.status == SURVEY.ST_STOPPED %}
                <div class="text-danger">
                    <div class="survey_state">
                        <i class="fa fa-stop"></i>
                    </div>
                    <div>Stopped</div>
                </div>
            {% endif %}
            <!-- /Status -->
        </div>
    </div>
{% endblock %}

{% block content %}

    <div class="wrapper_admin_content" ng-controller="MainCtrl">
        <table class="table_tab_admin">
            <tr>
                <td class="admin_tabs" valign="top">
                    <div class="list-group list_group_tabs">
                        <a ui-sref="summary" class="list-group-item"
                           ng-class="{'active': $state.current.name=='summary'}">
                            <i class="fa fa-bar-chart-o list_md_icon"></i>
                            Summary
                        </a>
                        <a ui-sref="responses" class="list-group-item"
                           ng-class="{'active': $state.current.name=='responses'}">
                            <i class="fa fa-comments-o list_md_icon"></i>
                            Responses
                        </a>
                        <a ui-sref="visualize" class="list-group-item"
                           ng-class="{'active': $state.current.name=='visualize'}">
                            <i class="fa fa-pie-chart list_md_icon"></i>
                            Visualize
                        </a>
                        <a ui-sref="edit" class="list-group-item" ng-class="{'active': $state.current.name=='edit'}">
                            <i class="fa fa-pencil-square-o list_md_icon"></i>
                            Review/Edit
                        </a>
                    </div>
                </td>
                <td class="admin_content" valign="top">
                    <!-- Partial view div -->
                    <div ui-view></div>
                    <!-- Partial view div -->
                </td>
            </tr>
        </table>
    </div>

{% endblock %}

{% block scripts %}
    <script src="{% get_static_prefix %}ui/js/ui-router/angular-ui-router.min.js"></script>
    <script src="{% get_static_prefix %}ui/js/plugins/sweetalert/sweetalert.min.js"></script>
    <script src="{% get_static_prefix %}ui/js/plugins/sweetalert/angular-sweetalert.min.js"></script>
    <script src="{% get_static_prefix %}ui/js/plugins/datapicker/bootstrap-datepicker.js"></script>
    {% if has_gps_enabled %}
{#    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDQTpXj82d8UpCi97wzo_nKXL7nYrd4G70"></script>#}
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js"></script>
    <script type="text/javascript" src="{% get_static_prefix %}lib/maps/markerwithlabel_1_1_10.js"></script>
    {% endif %}
    <script type="text/javascript" src="{% get_static_prefix %}lib/jquery-tmpl/jquery.tmpl.min.js"></script>

{#    <!-- jqGrid -->#}
    <script src="{% get_static_prefix %}ui/js/plugins/jqGrid/i18n/grid.locale-en.js"></script>
    <script src="{% get_static_prefix %}ui/js/plugins/jqGrid/jquery.jqGrid.min.js"></script>

    <script src="{% get_static_prefix %}lib/angular/angular-jqgrid/angular-jqgrid.js"></script>
    <script src="{% get_static_prefix %}ui/js/plugins/daterangepicker/daterangepicker.js"></script>
    <script src="{% get_static_prefix %}ui/js/plugins/daterangepicker/angular-daterangepicker.js"></script>


    <script src="{% get_static_prefix %}apps/surveys/surveys.js"></script>
    <script>
        'use strict';

        var APP = angular.module('{{ app_name }}', [
                    'feedvay.uiapp',
                    'feedvay.common',
                    'feedvay.watchdog',
                    'feedvay.surveys',

                    'ngCookies',
                    'ngMessages',
                    'ngSanitize',
                    'ui.router',                    // Routing
                    'oc.lazyLoad',                  // ocLazyLoad
                    'ui.bootstrap',
                    'angular-ladda',
                    'oitozero.ngSweetAlert',
                    'daterangepicker',
                    'angular-jqgrid',
                ])
                .config(function ($interpolateProvider, $httpProvider, $stateProvider, $urlRouterProvider, $ocLazyLoadProvider) {
                    $interpolateProvider.startSymbol('{$');
                    $interpolateProvider.endSymbol('$}');

                    $httpProvider.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest';
                    $httpProvider.defaults.headers.post['Content-Type'] = 'application/x-www-form-urlencoded;charset=utf-8';

                    // ----- Routing -----
                    $urlRouterProvider.otherwise("/summary");   // Default state to load

                    $ocLazyLoadProvider.config({
                        // Set to true if you want to see what and when is dynamically loaded
                        debug: false
                    });

                    $stateProvider
                            .state('summary', {
                                url: "/summary",
                                templateUrl: "tmpl_summary",
                                data: {pageTitle: 'Summary - {{ survey.title }}'},
                                controller: SummaryCtrl,
                                resolve: {
                                    loadPlugin: function ($ocLazyLoad) {
                                        return $ocLazyLoad.load([
                                            {
                                                files: ['{% get_static_prefix %}ui/js/plugins/chartJs/Chart.min.js']
                                            },
                                            {
                                                name: 'angles',
                                                files: ['{% get_static_prefix %}ui/js/plugins/chartJs/angles.js']
                                            }
                                        ]);
                                    }
                                }
                            })
                            .state('responses', {
                                url: "/responses",
                                templateUrl: "tmpl_responses",
                                data: {pageTitle: 'Responses - {{ survey.title }}'},
                                controller: ResponsesCtrl,
                                resolve: {
                                    loadPlugin: function ($ocLazyLoad) {
                                        return $ocLazyLoad.load([
                                            {% if has_gps_enabled %}
                                                {
                                                    name: 'ui.event',
                                                    files: ['{% get_static_prefix %}ui/js/plugins/uievents/event.js']
                                                },
                                                {
                                                    name: 'ui.map',
                                                    files: ['{% get_static_prefix %}ui/js/plugins/uimaps/ui-map.js']
                                                },
                                            {% endif %}
                                        ]);
                                    }
                                }
                            })
                            .state('visualize', {
                                url: "/visualize",
                                templateUrl: "tmpl_visualize",
                                data: {pageTitle: 'Visualize - {{ survey.title }}'},
                                {#                    controller: ControlsCtrl,#}
                            })
                            .state('edit', {
                                url: "/edit",
                                templateUrl: "tmpl_edit",
                                data: {pageTitle: 'Review/Edit - {{ survey.title }}'},
                                controller: ReviewEditCtrl,
{#                                resolve: {#}
{#                                    loadPlugin: function ($ocLazyLoad) {#}
{#                                        return $ocLazyLoad.load([#}
{#                                            {#}
{#                                                serie: true,#}
{#                                                files: [#}
{#                                                    '',#}
{#                                                    ''#}
{#                                                ]#}
{#                                            },#}
{#                                            {#}
{#                                                name: '',#}
{#                                                files: ['']#}
{#                                            }#}
{#                                        ]);#}
{#                                    }#}
{#                                }#}
                            })


                })
                .run(function ($rootScope, $http, $cookies, $state) {
                    $http.defaults.headers.post['X-CSRFToken'] = $cookies.csrftoken;

                    $http.defaults.xsrfCookieName = 'csrftoken';
                    $http.defaults.xsrfHeaderName = 'X-CSRFToken';

                    // ----- Routing -----
                    $rootScope.$state = $state;

                    $rootScope.$on('$stateChangeError', function (event, toState, toParams, fromState, fromParams, error) {
                        event.preventDefault();

                        if (error.status == -1) {
                            $.growl.error({
                                title: '<i class="fa fa-signal"></i> Network error!',
                                message: "Please check your internet connection."
                            });
                        } else {
                            $.growl.error({
                                title: '<i class="fa fa-exclamation-triangle"></i> Error!',
                                message: "Something went wrong. Our engineers will be informed."
                            });
                        }

                    });

                    // ----- Survey -----
                    $rootScope.survey = {
                        type: "{{ survey.type }}",
                        category: "{{ survey.category_id }}",
                        title: "{{ survey.title }}",
                        description: "{{ survey.description|safe }}",
                        duration: {
                            startDate: moment('{{ survey.start_date|date:"Y-m-d" }}', 'YYYY-MM-DD'),
                            endDate: moment('{{ survey.end_date|date:"Y-m-d" }}', 'YYYY-MM-DD'),
                        },
                        audience_type: "{{ survey.audience_type }}",
                    };

                    $rootScope.summernote_config = SUMMERNOTE_CONFIG;

                });


        APP.controller('MainCtrl', function ($scope) {

        });

        // ========== State Controllers ==========
        // ----- Summary -----
        function SummaryCtrl($rootScope, $scope, $http, $window, SweetAlert, ServiceSurveyAPI) {

            $scope.survey_transit = function (action) {

                var text = null;
                var type = 'warning';
                switch (action) {
                    case 'ready':
                    {
                        text = 'Do you want to make this survey live?';
                        type = 'info';
                    }
                        break;
                    case 'pause':
                    {
                        text = 'Do you want to pause this survey?';
                    }
                        break;
                    case 'resume':
                    {
                        text = 'Do you want to resume this survey and go live again?';
                        type = 'info';
                    }
                        break;
                    case 'stop':
                    {
                        text = 'This will permanently stop your survey and you will not be able to resume it!';
                    }
                        break;
                }

                SweetAlert.swal({
                            title: "Are you sure?",
                            text: text,
                            type: type,
                            showCancelButton: true,
                            {#                    confirmButtonColor: "#DD6B55",#}
                            confirmButtonText: "Yes, confirm!",
                            cancelButtonText: "No, cancel!",
                            closeOnConfirm: false,
                            closeOnCancel: true,
                            allowEscapeKey: false
                        },
                        function (isConfirm) {
                            if (isConfirm) {

                                $http.post(
                                        "/console/surveys/{{ survey.survey_uid }}/transit/",
                                        $.param({
                                            "action": action
                                        })
                                        )
                                        .success(function (response, status, headers, config) {
                                            if (response.status == 'success') {
                                                SweetAlert.swal("Done!", "Status of this survey has been changed.", "success");
                                                $window.location.reload();
                                            } else {
                                                swal.close();
                                                $.growl.error({
                                                    title: '<i class="fa fa-exclamation-triangle"></i> Error!',
                                                    message: response.message
                                                });
                                            }
                                        })
                                        .error(function (response, status, headers, config) {
                                            if (status != -1) {
                                                $.growl.error({
                                                    title: '<i class="fa fa-exclamation-triangle"></i> Error!',
                                                    message: 'Something went wrong. Our engineers will be informed.'
                                                });
                                            } else {
                                                $.growl.error({
                                                    title: '<i class="fa fa-signal"></i> Network error!',
                                                    message: "Please check your internet connection."
                                                });
                                            }
                                        });

                            }
                        });
            };

            {% if survey.status != SURVEY.ST_DRAFT %}
            $scope.ui_flags = {
                loading: false,
                error: false,
                error_msg: null
            };
            $scope.data_dashboard = {
                count_today: 0,
                total: 0,
                count_suspects: 0,
                trend_chart: {
                    options: {
                        scaleShowGridLines : true,
                        scaleGridLineColor : "rgba(0,0,0,.05)",
                        scaleGridLineWidth : 1,
                        bezierCurve : true,
                        bezierCurveTension : 0.4,
                        pointDot : true,
                        pointDotRadius : 4,
                        pointDotStrokeWidth : 1,
                        pointHitDetectionRadius : 20,
                        datasetStroke : true,
                        datasetStrokeWidth : 2,
                        datasetFill : true,
                    },
                    data: null
                }
            };
            $scope.get_response_trend = function(){
                $scope.ui_flags.loading = true;
                $scope.ui_flags.error = false;
                $scope.ui_flags.error_msg = null;

                ServiceSurveyAPI.get_response_trend('{{ survey.survey_uid }}', null).then(
                    function (response_data) {
                        $scope.ui_flags.loading = false;

                        var data_response_trend = response_data.objects;

                        var count_today = 0;
                        var total = 0;
                        var count_suspects = 0;
                        var chart_data_dict = {};

                        for(var i=0;i<data_response_trend.length;i++){
                            var row = data_response_trend[i];

                            var response_date = row['response_date'];

                            if(response_date == moment().format('YYYY-MM-DD')){
                                count_today++;
                            }

                            if(row['suspect']){
                                count_suspects++;
                            }

                            total += row['count'];

                            // --- Chart data ---
                            if(chart_data_dict[response_date] == undefined){
                                chart_data_dict[response_date] = {
                                    "suspects": 0,
                                    "non_suspects": 0
                                }
                            }

                            if(row['suspect']){
                               chart_data_dict[response_date]["suspects"] += row['count'];
                            }else{
                                chart_data_dict[response_date]["non_suspects"] += row['count'];
                            }
                            // --- /Chart data ---
                        }

                        // Set dashboard data
                        $scope.data_dashboard.count_today = count_today;
                        $scope.data_dashboard.total = total;
                        $scope.data_dashboard.count_suspects = count_suspects;

                        // --- Chart data ---
                        var labels = [];
                        var series_non_suspects = [];
                        var series_suspects = [];
                        for(var dt in chart_data_dict){
                            labels.push(moment(dt, 'YYYYY-MM-DD').format('DD-MMM-YYYY'));

                            series_non_suspects.push(chart_data_dict[dt]['non_suspects']);
                            series_suspects.push(chart_data_dict[dt]['suspects']);
                        }

                        $scope.data_dashboard.trend_chart.data = {
                            labels: labels,
                            datasets: [
                                {
                                    label: "Responses",
                                    fillColor: "rgba(42, 148, 219, 0.5)",
                                    strokeColor: "rgba(42, 148, 219, 0.7)",
                                    pointColor: "rgba(42, 148, 219, 1)",
                                    pointStrokeColor: "#fff",
                                    pointHighlightFill: "#fff",
                                    pointHighlightStroke: "rgba(42, 148, 219, 1)",
                                    data: series_non_suspects
                                },
                                {
                                    label: "Suspects",
                                    fillColor: "rgba(237, 85, 101, 0.5)",
                                    strokeColor: "rgba(237, 85, 101, 1)",
                                    pointColor: "rgba(237, 85, 101, 1)",
                                    pointStrokeColor: "#fff",
                                    pointHighlightFill: "#fff",
                                    pointHighlightStroke: "rgba(237, 85, 101, 1)",
                                    data: series_suspects
                                },
                            ]
                        }
                        // --- Chart data ---
                    },
                    function(response){
                        $scope.ui_flags.loading = false;
                        $scope.ui_flags.error = true;

                        if(response.status != -1){
                            $scope.ui_flags.error_msg = "Something went wrong. Our engineers will be informed.";
                        }else{
                            $scope.ui_flags.error_msg = "Please check your internet connection.";
                        }
                    }
                );
            };

            $scope.get_response_trend();
            {% endif %}
        }

        // ----- Responses -----
        function ResponsesCtrl($rootScope, $scope, ServiceSurveyResponses) {
            // filters
            $scope.filters_response = {};
            $scope.ui_flags = {
                loading: false,
                loaded: false
            };

            // Jqgrid
            $scope.grid_responses = {
                gridid: "grid_response",
                pagerid: "grid_response_pager",
                config: {
                    datatype: "local",
                    colNames: [
                        '',
                        'ResponseUID',
                        'DateTime',
                        'Respondent name',
                        'Respondent contact',
                        'Is suspect',
                        'Suspect reasons',
                        'Metadata',
                        ''
                    ],
                    colModel: [
                        { name: 'row_id', index: 'row_id', width: 50, search:false },
                        { name: 'response_uid', index: 'response_uid', width: 40, key:true, hidden:true },
                        { name: 'response_date', index: 'response_date', width: 150,
                            sorttype:'date', formatter: "date", formatoptions: { srcformat: 'Y-m-dTH:i:s', newformat: 'd-M-Y h:i A' },
{#                            searchoptions:{attr:{placeholder:'yyyy-mm-dd'}},#}
                            searchoptions: {
{#                                attr:{placeholder:'yyyy-mm-dd', readonly:'readonly'},#}
                                attr:{ placeholder: 'Select date', readonly:'readonly'},
                                dataInit: function (elem) {
                                    $(elem).datepicker({
{#                                        format: 'dd-M-yyyy',#}
                                        format: 'yyyy-mm-dd',
                                        keyboardNavigation: false,
                                        autoclose: true,
                                        todayHighlight: true,
                                    }).on('changeDate', function(e) {
                                        $('#grid_response')[0].triggerToolbar();
                                    });
                                }
                            }
                        },
                        { name: 'user.user_fullname', index: 'user.user_fullname', width: 170 },
                        { name: 'user.username', index: 'user.username', width: 170 },
                        { name: 'suspect_html', index: 'flags.suspect', width: 90, align:"center",
                            stype: 'select', searchoptions:{ sopt:['cn'], value: ":All;true:Yes;false:No", clearSearch: false}
                        },
                        { name: 'flags.suspect_reasons', index: 'flags.suspect_reasons', width: 300 },
                        { name: 'meta_icons', index: 'meta_icons', width: 170, search:false, sortable:false },
                        { name: 'actions', index: 'actions', width: 80, search:false, sortable:false },

                    ],
                    viewrecords: true,
{#                    caption:"Responses",#}
                    sortname: 'response_date',
                    sortorder: "desc",
                    rowNum: 50,
                    rowList: [10, 50, 100, 100000],
                    autowidth : true,
                    height: '300px',
                    shrinkToFit: true,
                    hidegrid: false,
                    ignoreCase:true,
                    onSelectRow: function(response_uid) {
                        {% if has_gps_enabled %}
                            google.maps.event.trigger($scope.map_markers[response_uid], 'click');
                        {% endif %}
                    }
                },
                filtertoolbar: {
                    stringResult: true, searchOnEnter: false, defaultSearch: 'cn',
                },
                gridapi: {}
            };

            {% if has_gps_enabled %}
                // Map
                $scope.mapOptions = {
                    zoom: 4,
                    center: new google.maps.LatLng(21, 78),
                    mapTypeId: google.maps.MapTypeId.ROADMAP,
                    zoomControl:true,
                    scaleControl:true,
                    streetViewControl:true,
                    overviewMapControl:true,
                    rotateControl:true,

                };
                $scope.map_markers = {};
            {% endif %}

            $scope.list_responses = [];
            $scope.view_response_report = function(){
                var filters = angular.copy($scope.filters_response);

                // Correct parameters
                for(var key in filters){
                    if(key.includes('__')){
                        var val = filters[key];
                        var new_key = key.replace(/__/g,'.');
                        delete filters[key];
                        filters[new_key] = val;
                    }
                }

                if(filters['response_date']){
                    filters['response_date__gte'] =  filters['response_date']['startDate'].format('YYYY-MM-DD');
                    filters['response_date__lte'] =  filters['response_date']['endDate'].add(1, 'days').format('YYYY-MM-DD');
                    delete filters['response_date'];
                }

                // --- Get data & display ---
                $scope.ui_flags.loading = true;

                ServiceSurveyResponses.get('{{ survey.survey_uid }}', filters).then(
                    function (response_data) {
                        $scope.ui_flags.loading = false;
                        $scope.ui_flags.loaded = true;

                        var records = response_data.objects;

                        // --- Process data ---
                        var ENUM_META_ICO = {
                            "map": {
                                "ok": '<i class="fa fa-map-marker list_md_icon meta_icons" data-toggle="tooltip" data-placement="bottom" title="" data-original-title="Has location" onclick="$(\'html, body\').animate({ scrollTop: $(\'#div_map_responses\').offset().top-20 }, \'fast\');"></i>',
                                "none": '<i class="fa fa-map-marker list_md_icon meta_icons_disabled"></i>'
                            },
                            "description_read": {
                                "ok": '<i class="fa fa-eye list_md_icon meta_icons" data-toggle="tooltip" data-placement="bottom" title="" data-original-title="Description was read"></i>',
                                "none": '<i class="fa fa-eye list_md_icon meta_icons_disabled"></i>'
                            },
                            "instructions_read": {
                                "ok": '<i class="fa fa-book list_md_icon meta_icons" data-toggle="tooltip" data-placement="bottom" title="" data-original-title="Instructions were read"></i>',
                                "none": '<i class="fa fa-book list_md_icon meta_icons_disabled"></i>'
                            },
                            "has_ai":{
                                "ok": '<i class="fa fa-android list_md_icon meta_icons" data-toggle="tooltip" data-placement="bottom" title="" data-original-title="Artificial intelligence applied"></i>',
                                "none": '<i class="fa fa-android list_md_icon meta_icons_disabled"></i>'
                            }
                        };

                        for(var i=0;i<records.length;i++){
                            var row = records[i];
                            var flags = row['flags'];

                            records[i]["row_id"] = (i+1)+"";
                            records[i]["suspect_html"] = flags['suspect']?'<span class="text-danger"><i class="fa fa-question"></i> Suspect</span>':'';

                            var meta_icons = {% if has_gps_enabled %}(row['location']['coordinates']?ENUM_META_ICO["map"]["ok"]:ENUM_META_ICO["map"]["none"])+{% endif %}
                                    (flags['description_read']?ENUM_META_ICO["description_read"]["ok"]:ENUM_META_ICO["description_read"]["none"])
                                    + (flags['instructions_read']?ENUM_META_ICO["instructions_read"]["ok"]:ENUM_META_ICO["instructions_read"]["none"])
                                    + (flags['has_ai']?ENUM_META_ICO["has_ai"]["ok"]:ENUM_META_ICO["has_ai"]["none"]);
                            records[i]["meta_icons"] = meta_icons;

                            records[i]['actions'] = '<a href="/console/surveys/{{ survey.survey_uid }}/response/'+row['response_uid']+'/" class="btn btn-primary btn-xs btn-outline grid_btn" target="_blank">View</a>';
                        }

                        // --- /Process data ---

                        $scope.list_responses = records;
                        var filtered = false;
                        for(var k in filters){
                            if(filters[k]){
                                filtered = true;
                                break;
                            }
                        }

                        $scope.grid_responses.gridapi.clear();
                        $scope.grid_responses.gridapi.insert(records);
                        $("#grid_response").jqGrid('setCaption',
                            $("#jqtmpl_grip_response_caption").tmpl({
                                "length": records.length,
                                "filtered": filtered
                            }).html()
                        );

                        $('.meta_icons').tooltip();
                        $('.tool_tip').tooltip();

                        {% if has_gps_enabled %}
                            // --- Map ---
                            $("#div_map_responses").show();
                            google.maps.event.trigger($scope.MAP_RESPONSES, 'resize');

                            // Clear map
                            for(var r_uid in $scope.map_markers){
                                var mrkr = $scope.map_markers[r_uid];
                                mrkr.setMap(null);
                            }
                            $scope.map_markers = {};

                            // Create map
                            var map_bounds = new google.maps.LatLngBounds();
                            for(var i=0;i<records.length;i++){
                                var row = records[i];

                                // Create markers
                                var coord = row['location']['coordinates']; //Long, Lat
                                if(coord){
                                    var point = new google.maps.LatLng(coord[1], coord[0]);
            {#                        var marker = new google.maps.Marker({#}
            {#                            position: point,#}
            {#                            icon: "{% get_static_prefix %}images/markers/marker_response.png",#}
            {#                            map: $scope.MAP_RESPONSES,#}
            {#                            data: $.extend({}, row),#}
            {#                        });#}
                                    var marker = new MarkerWithLabel({
                                        position: point,
                                        map: $scope.MAP_RESPONSES,
                                        data: $.extend({}, row),
                                        icon: "{% get_static_prefix %}images/markers/marker_response.png",
                                        labelContent: row["row_id"],
                                        labelAnchor: new google.maps.Point(15, 36),
                                        labelClass: "marker_label", // the CSS class for the label
                                        labelInBackground: false,
                                        labelVisible: true
                                    });


                                    // Marker events
                                    var infowindow = new google.maps.InfoWindow({
                                        content: " "
                                    });
                                    google.maps.event.addListener(marker, 'click', function () {
                                        var content = $("#jqtmpl_map_response_dialogue").tmpl(this.data).html();

                                        infowindow.setContent(content);
                                        infowindow.open($scope.MAP_RESPONSES, this);
                                    });


                                    $scope.map_markers[row['response_uid']] = marker;
                                    map_bounds.extend(point);

                                }
                            }

                            if(records.length>1) {
                                $scope.MAP_RESPONSES.fitBounds(map_bounds);
                            }else{
                                $scope.MAP_RESPONSES.panTo(point);
                                $scope.MAP_RESPONSES.setZoom(10);
                            }
                            // --- Map ---
                        {% endif %}
                    },
                    function(response){
                        $scope.ui_flags.loading = false;

                        if(response.status != -1){
                            $.growl.error({
                                title: '<i class="fa fa-exclamation-triangle"></i> Error!',
                                message: "Something went wrong. Our engineers will be informed."
                            });
                        }else{
                            $.growl.error({
                                title: '<i class="fa fa-signal"></i> Network error!',
                                message: "Please check your internet connection."
                            });
                        }

                    }
                );
            };
        }

        // ----- Review/Edit -----
        function ReviewEditCtrl($rootScope, $scope, $http, $window) {
            $scope.list_categories = [
                {% for c in list_categories %}
                    { "id": "{{ c.id }}", "name": "{{ c.name }}"},
                {% endfor %}
            ];

            $scope.daterange_opt = {
                min: moment.min(moment('{{ survey.start_date|date:"Y-m-d" }}', 'YYYY-MM-DD'), moment()).format('YYYY-MM-DD')
            };

            $scope.flags = {
                submitting: false,
                error_msg: null,
                val_errors: null
            };

            $scope.submit = function (form_obj) {
                if (form_obj.$invalid) {
                    return false;
                }

                $scope.flags.submitting = true;
                $scope.flags.error_msg = null;
                $scope.flags.val_errors = null;

                var data = angular.copy($rootScope.survey);
                data['start_date'] = data['duration']['startDate'].format('YYYY-MM-DD');
                data['end_date'] = data['duration']['endDate'].format('YYYY-MM-DD');
                delete data['duration'];

                $http.post(
                        "/console/surveys/{{ survey.survey_uid }}/save/",
                        $.param(data)
                        )
                        .success(function (response, status, headers, config) {
                            if (response.status == 'success') {
                                $window.location.reload();
                            } else {
                                $scope.flags.submitting = false;
                                $scope.flags.error_msg = response.message;
                                $scope.flags.val_errors = response.errors;
                            }
                        })
                        .error(function (response, status, headers, config) {
                            $scope.flags.submitting = false;

                            if (status != -1) {
                                $scope.flags.error_msg = 'Something went wrong. Our engineers will be informed.'
                            } else {
                                $.growl.error({
                                    title: '<i class="fa fa-signal"></i> Network error!',
                                    message: "Please check your internet connection."
                                });
                            }
                        });

            }
        }
        // ----- /Review/Edit -----
        // ========== /State Controllers ==========

    </script>
{% endblock %}