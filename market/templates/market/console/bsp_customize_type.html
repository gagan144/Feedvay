{# Copyright (C) 2017 Feedvay (Gagandeep Singh: singh.gagan144@gmail.com) - All Rights Reserved #}
{# Content in this document can not be copied and/or distributed without the express #}
{# permission of Gagandeep Singh. #}
{% extends 'console/base.html' %}
{% load static commontags %}

{% block head %}
    <!-- Favicon -->
    <link rel="shortcut icon"  href="{{ request.curr_org.icon.url }}" />

    <title>Customize a type | {{ request.curr_org.name }}</title>
{% endblock %}

{% block page_header %}
    <div class="row wrapper border-bottom white-bg page-heading">
        <div class="col-xs-8">
            <h2>
                <i class="fa fa-pencil"></i>
                Customize a type
            </h2>
            <ol class="breadcrumb">
                <li>
                    <a href="{% url 'console_org_home' %}?c={{ request.curr_org.org_uid }}">Home</a>
                </li>
                <li>
                    <a href="{% url 'console_market_bsp_panel' %}?c={{ request.curr_org.org_uid }}">Business or Service Point</a>
                </li>
                <li class="active">
                    Customize a type
                </li>
            </ol>
        </div>
    </div>
{% endblock %}

{% block content %}
    <div class="wrapper wrapper-content">
        <div class="container">
            {% if list_available_types %}
                <div class="content_box" ng-controller="CustomizeType" ng-cloak>
                    <form name="form_customize_type" class="form-horizontal" novalidate>
                        {$ data $}

                        <!-- PArtial -->
                        <div class="form-group">
                            <label class="col-sm-3 control-label">BSP Type<span class="required">*</span>:</label>
                            <div class="col-sm-7">
                                <select ng-model="data.bsp_type" name="bsp_type" class="form-control" required ng-change="onchange_bsp_type();">
                                    <option value="">Select type</option>
                                    <option ng-repeat="type in list_avail_types" ng-value="type.id">{$ type.name $}</option>
                                </select>
                                <p class="help-block">
                                    Type of BSP you want to customize.
                                </p>

                                <div ng-messages="form_customize_type.bsp_type.$dirty && form_customize_type.bsp_type.$error" role="alert" class="error_messages">
                                    <label ng-message="required" class="error">Please select a type which you want to customize.</label>
                                </div>
                                <label ng-if="flags.errors.bsp_type" class="error">
                                    {$ flags.errors.bsp_type.join(", "); $}
                                </label>
                            </div>
                        </div>

                        <div class="hr-line-dashed"></div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">Custom attributes<span class="required">*</span>:</label>
                            <div class="col-sm-7" style="padding-top: 4px;">
                                <div class="help-block">
                                    To capture more attributes for a BSP of the type apart from predefined ones, add attributes by clicking below
                                    button.
                                    <br/><br/>
                                    Please note that custom attribute cannot have label present in <a href="javascript: void(0);" ng-click="view_reserved_labels=true;">reserved labels</a>. These reserved label are those which
                                    are already defined for the BSP.

                                    <div class="panel panel-default" ng-show="view_reserved_labels" style="margin-top: 5px;">
                                        <div class="panel-heading">
                                            Reserved labels
                                            <a class="pull-right" href="javascript: void(0);" ng-click="view_reserved_labels=false;"><i class="fa fa-times"></i></a>
                                        </div>
                                        <div class="panel-body">
                                            <div class="row">
                                                <div class="col-md-4" ng-repeat="lbl in reserved_labels.common">{$ lbl $}</div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-4" ng-repeat="lbl in reserved_labels.type_wise">{$ lbl $}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <table class="table table-striped" style="margin-bottom: 0px;">
                                    <thead>
                                        <tr>
                                            <th>
                                                Label<span class="required">*</span>
                                                &nbsp;
                                                <i class="fa fa-info-circle custom_tooltip" tooltip-placement="top" uib-tooltip="A label is something that will be used to refer this attribute. This must be unique."></i>
                                            </th>
                                            <th>
                                                Name<span class="required">*</span>
                                                &nbsp;
                                                <i class="fa fa-info-circle custom_tooltip" tooltip-placement="top" uib-tooltip="Human readable name of the attribute."></i>
                                            </th>
                                            <th>
                                                Data type<span class="required">*</span>
                                                &nbsp;
                                                <i class="fa fa-info-circle custom_tooltip" tooltip-placement="top" uib-tooltip="Type of value for this attribute."></i>
                                            </th>
                                            <th style="width: 20px;">&nbsp;</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr ng-repeat="attr in data.schema">
                                            <td>
                                                <input type="text" class="form-control input-sm" ng-model="attr.label" name="attr_label_{$ $index $}" val-variable-name required ng-class="{'error':form_customize_type['attr_label_'+$index].$invalid}">
                                            </td>
                                            <td>
                                                <input type="text" class="form-control input-sm" ng-model="attr.name" name="attr_name_{$ $index $}" required ng-class="{'error':form_customize_type['attr_name_'+$index].$invalid}">
                                            </td>
                                            <td>
                                                <select ng-model="attr.dtype" name="attr_dtype_{$ $index $}" class="form-control input-sm" required ng-class="{'error':form_customize_type['attr_dtype_'+$index].$invalid}">
                                                    <option value="">Select</option>
                                                    <option ng-repeat="dt in list_dtypes" ng-value="dt.id">{$ dt.name $}</option>
                                                </select>
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-danger btn-outline btn-xs" ng-click="remove_attr($index);">
                                                    <i class="fa fa-times"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td colspan="4">
                                                <button type="button" class="btn btn-primary btn-xs" ng-click="add_attr();">
                                                    <i class="fa fa-plus"></i> Add new attribute
                                                </button>
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                                <div role="alert" class="error_messages" ng-if="!data.schema.length">
                                    <label class="error">Please add atleast one attribute.</label>
                                </div>
                                <label ng-if="flags.errors.schema" class="error">
                                    {$ flags.errors.schema.join(", "); $}
                                </label>
                            </div>
                        </div>

                        <!-- /PArtial -->
                        <div class="hr-line-dashed"></div>
                        <div class="form-group">
                            <div class="col-sm-7 col-md-offset-3">
                                <p ng-if="flags.status==ST_AJAX.ERROR" class="text-danger">
                                    <i class="fa fa-exclamation-triangle"></i> {$ flags.error_msg $}
                                </p>
                                <button type="button" ladda="flags.status==ST_AJAX.LOADING"  class="btn btn-primary ladda-button" ng-disabled="form_customize_type.$invalid" ng-click="submit_customization(form_customize_type);" data-style="zoom-in">
                                    Customize
                                </button>
                                <a href="{% url 'console_market_bsp_panel' %}?c={{ request.curr_org.org_uid }}#/customize_types" class="btn btn-link">
                                    Cancel
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            {% else %}
                <div class="alert alert-success">
                    <table style="width: 100%">
                        <tr>
                            <td valign="top" style="width: 90px;">
                                <i class="fa fa-check-circle" style="font-size: 80px;"></i>
                            </td>
                            <td valign="top">
                                <h2 style="margin-top: 0px;">All types are already customized!</h2>
                                <div>
                                    All Business or Service Point types have been customized.
                                    <br/>
                                    Go to <a href="{% url 'console_market_bsp_panel' %}?c={{ request.curr_org.org_uid }}#/customize_types">customized types</a> to view
                                    all customization.
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
            {% endif %}
        </div>
    </div>

{% endblock %}

{% block scripts %}
    <script src="{% get_static_prefix %}apps/market/bsp.js"></script>
    <script>
        'use strict';

        var APP = angular.module('{{ app_name }}',[
            'feedvay.uiapp',
            'feedvay.common',
            'feedvay.watchdog',
            'feedvay.market.bsp',

            'ngCookies',
            'ngMessages',
            'ui.bootstrap',
            'angular-ladda'
        ])
        .run(function($rootScope, $http, $cookies) {
            $http.defaults.headers.post['X-CSRFToken'] = $cookies.csrftoken;

            $http.defaults.xsrfCookieName = 'csrftoken';
            $http.defaults.xsrfHeaderName = 'X-CSRFToken';

            $rootScope.ST_AJAX = ST_AJAX;
        })
        .config(function($interpolateProvider, $httpProvider) {
            $interpolateProvider.startSymbol('{$');
            $interpolateProvider.endSymbol('$}');

            $httpProvider.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest';
            $httpProvider.defaults.headers.post['Content-Type'] = 'application/x-www-form-urlencoded;charset=utf-8';
        });

        APP.controller('CustomizeType', function($scope, $http, $window, ServiceBsp){
            {% if list_available_types %}
                $scope.list_avail_types = {{ list_available_types|jsonify|safe }};
                $scope.list_dtypes = {{ list_dtypes|jsonify|safe }};
                $scope.reserved_labels = {
                    common: {{ reserved_labels_common|jsonify|safe }},
                    type_wise: []
                };

                $scope.data = {
                    schema: []
                };

                // --- Functions ---
                $scope.onchange_bsp_type = function(){
                    if($scope.data.bsp_type){
                        ServiceBsp.get_labels($scope.data.bsp_type, 0).then(
                            function(response){
                                var data = response.objects;

                                var list_lbl = [];
                                for(var i=0;i<data.length;i++){
                                    list_lbl.push(data[i]['label']);
                                }
                                list_lbl.sort();

                                $scope.reserved_labels.type_wise = angular.copy(list_lbl);
                            }
                        );
                    }else{
                        $scope.reserved_labels.type_wise = [];
                    }
                };

                $scope.remove_attr = function(idx){
                    $scope.data.schema.splice(idx, 1);
                };

                $scope.add_attr = function(){
                    $scope.data.schema.push({});
                };
                // --- /Methods ---

                $scope.flags = {
                    status: null,
                    error_msg: null,
                    errors: null
                };
                $scope.submit_customization = function(form_obj){
                    if(form_obj.$invalid){
                        return false;
                    }

                    // Validate labels

                    // Prepare data
                    var data = angular.copy($scope.data);
                    data['schema'] = JSON.stringify(data['schema']);
                    data['c'] = "{{ request.curr_org.org_uid }}";

                    $scope.flags.status = ST_AJAX.LOADING;
                    $scope.flags.error_msg = null;
                    $scope.flags.errors = null;

                    $http.post(
                        "{% url 'console_market_customize_type_create' %}",
                        $.param(data)
                    )
                    .success(function (response, status, headers, config) {
                        if(response.status=='success'){
                            $window.location.href = '{% url 'console_market_bsp_panel' %}?c={{ request.curr_org.org_uid }}#/customize_types';
                        }else{
                            $scope.flags.status = ST_AJAX.ERROR;
                            $scope.flags.error_msg = response.message;
                            if(response.status == 'failed'){
                                $scope.flags.errors = response.errors;
                            }
                        }
                    })
                    .error(function (response, status, headers, config) {
                        if(status != -1){
                            $scope.flags.status = ST_AJAX.ERROR;
                            $scope.flags.error_msg = "Something went wrong. Our engineers will be informed.";
                        }else{
                            $scope.flags.status = null;
                            $.growl.error({
                                title: '<i class="fa fa-signal"></i> Network error!',
                                message: "Please check your internet connection."
                            });
                        }
                    });

                }
            {% endif %}

        });
    </script>
{% endblock %}

